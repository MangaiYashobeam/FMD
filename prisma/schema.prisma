// Production-level Prisma Schema for FaceMyDealer
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Account Management
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  phone         String?
  isActive      Boolean  @default(true) @map("is_active")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Personal Facebook Marketplace Credentials (for Chrome Extension)
  fbUsername    String?  @map("fb_username")
  fbPassword    String?  @map("fb_password") // Encrypted
  fb2faCodes    String[] @map("fb_2fa_codes") // Array of backup codes
  fbLastSync    DateTime? @map("fb_last_sync")

  // Relations
  accountUsers       AccountUser[]
  facebookProfiles   FacebookProfile[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  refreshTokens      RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  apiKeys            ApiKey[]

  @@map("users")
}

model Account {
  id              String   @id @default(uuid())
  name            String
  dealershipName  String?  @map("dealership_name")
  address         String?
  city            String?
  state           String?
  zip             String?
  phone           String?
  website         String?
  logoUrl         String?  @map("logo_url")
  isActive        Boolean  @default(true) @map("is_active")
  // Billing & Subscription
  stripeCustomerId String?  @unique @map("stripe_customer_id")
  subscriptionPlanId String? @map("subscription_plan_id")
  subscriptionStatus String  @default("trial") @map("subscription_status") // trial, active, past_due, canceled, paused
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  trialEndsAt        DateTime? @map("trial_ends_at")
  activeUserCount    Int      @default(0) @map("active_user_count")
  extraUserCharge    Decimal  @default(0) @map("extra_user_charge") @db.Decimal(10, 2)
  
  // FTP Configuration
  ftpHost         String?  @map("ftp_host")
  ftpPort         Int?     @map("ftp_port") @default(21)
  ftpUsername     String?  @map("ftp_username")
  ftpPassword     String?  @map("ftp_password") // Encrypted
  csvPath         String?  @map("csv_path")
  
  // Sync Settings
  autoSync        Boolean  @default(true) @map("auto_sync")
  syncInterval    Int      @default(3) @map("sync_interval") // hours
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  accountUsers      AccountUser[]
  vehicles          Vehicle[]
  ftpConfigurations FtpConfiguration[]
  syncJobs          SyncJob[]
  facebookProfiles  FacebookProfile[]
  settings          AccountSettings?
  subscriptionPlan  SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  payments          Payment[]
  invoices          Invoice[]
  apiKeys           ApiKey[]

  @@map("accounts")
}

// Role enum for AccountUser
enum UserRole {
  SUPER_ADMIN  // Company owner - full system access
  ACCOUNT_OWNER // Dealership owner - full account access
  ADMIN         // Account admin - manage users, settings, templates
  SALES_REP     // Sales representative - personal posting only
  VIEWER        // Read-only access
}

model AccountUser {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  userId    String   @map("user_id")
  role      UserRole @default(SALES_REP)
  permissions Json?  // Custom permissions override
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@map("account_users")
}

model AccountSettings {
  id                    String   @id @default(uuid())
  accountId             String   @unique @map("account_id")
  autoSyncEnabled       Boolean  @default(true) @map("auto_sync_enabled")
  syncIntervalHours     Int      @default(3) @map("sync_interval_hours")
  postsPerRun           Int      @default(1) @map("posts_per_run")
  autoMarkSold          Boolean  @default(true) @map("auto_mark_sold")
  autoUpdatePrice       Boolean  @default(true) @map("auto_update_price")
  includeStockNumber    Boolean  @default(true) @map("include_stock_number")
  useAiDescription      Boolean  @default(false) @map("use_ai_description")
  customDescription     String?  @map("custom_description") @db.Text
  vehicleCategory       String   @default("Car/Truck") @map("vehicle_category")
  emojiSuffix           String   @default("ðŸ¤˜") @map("emoji_suffix")
  mileageUnit           String   @default("Miles") @map("mileage_unit")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("account_settings")
}

// ============================================
// Facebook Integration
// ============================================

model FacebookProfile {
  id                String   @id @default(uuid())
  accountId         String   @map("account_id")
  userId            String   @map("user_id")
  pageId            String   @map("page_id") // Facebook Page ID
  pageName          String   @map("page_name")
  category          String   @default("Automotive") // Page category
  facebookUserId    String   @map("facebook_user_id")
  facebookUserName  String?  @map("facebook_user_name")
  accessToken       String   @map("access_token") @db.Text
  refreshToken      String?  @map("refresh_token") @db.Text
  tokenExpiresAt    DateTime @map("token_expires_at")
  isActive          Boolean  @default(true) @map("is_active")
  lastSyncAt        DateTime? @map("last_sync_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts   FacebookPost[]

  @@unique([accountId, pageId])
  @@map("facebook_profiles")
}

model FacebookPost {
  id                String   @id @default(uuid())
  vehicleId         String   @map("vehicle_id")
  profileId         String   @map("profile_id")
  postId            String?  @map("post_id") // Facebook post ID
  message           String?  @db.Text
  status            String   @default("pending") // PENDING, ACTIVE, FAILED, DELETED
  errorMessage      String?  @map("error_message") @db.Text
  postUrl           String?  @map("post_url")
  postedAt          DateTime? @map("posted_at")
  deletedAt         DateTime? @map("deleted_at")
  lastUpdatedAt     DateTime? @map("last_updated_at")
  retryCount        Int      @default(0) @map("retry_count")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  profile FacebookProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([profileId])
  @@map("facebook_posts")
}

// ============================================
// Vehicle Management
// ============================================

model Vehicle {
  id                  String   @id @default(uuid())
  accountId           String   @map("account_id")
  
  // Identifiers
  vin                 String
  stockNumber         String?  @map("stock_number")
  dealerId            String?  @map("dealer_id")
  
  // Basic Info
  year                Int
  make                String
  model               String
  trim                String?
  bodyStyle           String?  @map("body_style")
  bodyType            String?  @map("body_type")
  
  // Pricing
  price               Decimal? @db.Decimal(10, 2) // Primary price field
  listPrice           Decimal? @map("list_price") @db.Decimal(10, 2)
  specialPrice        Decimal? @map("special_price") @db.Decimal(10, 2)
  costPrice           Decimal? @map("cost_price") @db.Decimal(10, 2)
  wholesalePrice      Decimal? @map("wholesale_price") @db.Decimal(10, 2)
  
  // Specifications
  mileage             Int?
  exteriorColor       String?  @map("exterior_color")
  exteriorColorCode   String?  @map("exterior_color_code")
  interiorColor       String?  @map("interior_color")
  interiorColorCode   String?  @map("interior_color_code")
  interiorMaterial    String?  @map("interior_material")
  
  // Engine & Drivetrain
  engineDescription   String?  @map("engine_description")
  engineDisplacement  String?  @map("engine_displacement")
  cylinders           String?
  drivetrain          String?
  transmission        String?
  transmissionType    String?  @map("transmission_type")
  fuelType            String?  @map("fuel_type")
  cityMpg             Int?     @map("city_mpg")
  hwyMpg              Int?     @map("hwy_mpg")
  
  // Status
  isNew               Boolean  @default(false) @map("is_new")
  factoryCertified    Boolean  @default(false) @map("factory_certified")
  dealerCertified     Boolean  @default(false) @map("dealer_certified")
  status              String   @default("active") // active, sold, pending, hidden
  
  // Descriptions
  title               String?
  description         String?  @db.Text
  dealerComments      String?  @map("dealer_comments") @db.Text
  optionDescription   String?  @map("option_description") @db.Text
  optionCodes         String?  @map("option_codes") @db.Text
  
  // Metadata
  instockDate         DateTime? @map("instock_date")
  lastModifiedDate    DateTime? @map("last_modified_date")
  videoUrl            String?   @map("video_url")
  imageUrls           String[]  @default([]) @map("image_urls") // Array of image URLs
  source              String    @default("MANUAL") // MANUAL, FTP, API
  
  // Tracking
  lastSyncedAt        DateTime? @map("last_synced_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  photos        VehiclePhoto[]
  facebookPosts FacebookPost[]

  @@unique([accountId, vin])
  @@index([accountId, status])
  @@index([vin])
  @@index([stockNumber])
  @@map("vehicles")
}

model VehiclePhoto {
  id          String   @id @default(uuid())
  vehicleId   String   @map("vehicle_id")
  url         String
  displayOrder Int     @default(0) @map("display_order")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_photos")
}

// ============================================
// Data Sync & FTP
// ============================================

model FtpConfiguration {
  id          String   @id @default(uuid())
  accountId   String   @map("account_id")
  name        String
  host        String
  port        Int      @default(21)
  username    String
  password    String   // Encrypted in application
  path        String   @default("/")
  protocol    String   @default("ftp") // ftp, sftp, ftps
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lastTestedAt DateTime? @map("last_tested_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("ftp_configurations")
}

model SyncJob {
  id               String   @id @default(uuid())
  accountId        String   @map("account_id")
  triggeredBy      String?  @map("triggered_by") // User ID who triggered manual sync
  status           String   @default("pending") // PENDING, PROCESSING, COMPLETED, FAILED
  type             String   @default("auto") // auto, manual
  recordsImported  Int      @default(0) @map("records_imported")
  recordsUpdated   Int      @default(0) @map("records_updated")
  recordsFailed    Int      @default(0) @map("records_failed")
  vehiclesAdded    Int      @default(0) @map("vehicles_added")
  vehiclesUpdated  Int      @default(0) @map("vehicles_updated")
  vehiclesMarkedSold Int    @default(0) @map("vehicles_marked_sold")
  errorMessage     String?  @map("error_message") @db.Text
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
  @@map("sync_jobs")
}

// ============================================
// Security & Audit
// ============================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model ApiKey {
  id          String   @id @default(uuid())
  name        String   // Key identifier (e.g., "Chrome Extension - Desktop")
  keyHash     String   @unique @map("key_hash") // SHA256 hash of the key
  userId      String   @map("user_id")
  accountId   String   @map("account_id")
  permissions String[] @default([]) // Array of permissions
  isActive    Boolean  @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@map("api_keys")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String
  entityType  String?  @map("entity_type")
  entityId    String?  @map("entity_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // info, warning, error, success
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}
// ============================================
// Subscription & Billing Management
// ============================================

model SubscriptionPlan {
  id                String   @id @default(uuid())
  name              String   @unique // "Starter", "Growth", "Pro", "Enterprise Lifetime"
  slug              String   @unique @default("") // URL-friendly identifier
  description       String?  @db.Text // Plan description
  stripePriceId     String?  @unique @map("stripe_price_id")
  stripeProductId   String?  @map("stripe_product_id")
  basePrice         Decimal  @map("base_price") @db.Decimal(10, 2) // Monthly price
  billingInterval   String   @map("billing_interval") // "monthly", "yearly", "lifetime"
  includedUsers     Int      @map("included_users") // 10, 25, unlimited (-1)
  extraUserPrice    Decimal  @map("extra_user_price") @db.Decimal(10, 2) // Price per extra user
  maxVehicles       Int      @default(-1) @map("max_vehicles") // -1 = unlimited
  maxPosts          Int      @default(-1) @map("max_posts") // -1 = unlimited posts per month
  features          Json?    // JSON array of feature strings
  isActive          Boolean  @default(true) @map("is_active")
  isPopular         Boolean  @default(false) @map("is_popular") // Highlight as popular plan
  displayOrder      Int      @default(0) @map("display_order")
  
  // Lifetime plan specifics
  lifetimeDuration  Int?     @map("lifetime_duration") // In years (e.g., 4)
  renewalPrice      Decimal? @map("renewal_price") @db.Decimal(10, 2) // Price to renew lifetime
  revertToPlanId    String?  @map("revert_to_plan_id") // Plan ID to revert after lifetime expires
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  accounts          Account[]
  revertPlan        SubscriptionPlan? @relation("PlanReversion", fields: [revertToPlanId], references: [id])
  revertedPlans     SubscriptionPlan[] @relation("PlanReversion")

  @@map("subscription_plans")
}

model Payment {
  id                String   @id @default(uuid())
  accountId         String   @map("account_id")
  stripePaymentId   String   @unique @map("stripe_payment_id")
  stripeInvoiceId   String?  @map("stripe_invoice_id")
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("usd")
  status            String   // succeeded, pending, failed, refunded
  paymentMethod     String?  @map("payment_method") // card, bank_transfer, etc.
  description       String?  @db.Text
  metadata          Json?    // Extra data from Stripe
  paidAt            DateTime? @map("paid_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [stripeInvoiceId], references: [stripeInvoiceId])

  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Invoice {
  id              String   @id @default(uuid())
  accountId       String   @map("account_id")
  stripeInvoiceId String   @unique @map("stripe_invoice_id")
  invoiceNumber   String?  @unique @map("invoice_number")
  amountDue       Decimal  @map("amount_due") @db.Decimal(10, 2)
  amountPaid      Decimal  @map("amount_paid") @db.Decimal(10, 2)
  currency        String   @default("usd")
  status          String   // draft, open, paid, void, uncollectible
  hostedUrl       String?  @map("hosted_url") @db.Text
  pdfUrl          String?  @map("pdf_url") @db.Text
  
  // Line items breakdown
  baseCharge      Decimal  @default(0) @map("base_charge") @db.Decimal(10, 2)
  extraUserCharge Decimal  @default(0) @map("extra_user_charge") @db.Decimal(10, 2)
  extraUserCount  Int      @default(0) @map("extra_user_count")
  
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")
  dueDate         DateTime? @map("due_date")
  paidAt          DateTime? @map("paid_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([accountId])
  @@index([status])
  @@map("invoices")
}

model SubscriptionHistory {
  id              String   @id @default(uuid())
  accountId       String   @map("account_id")
  planId          String?  @map("plan_id")
  planName        String   @map("plan_name")
  action          String   // created, upgraded, downgraded, canceled, renewed, expired
  previousPlan    String?  @map("previous_plan")
  newPlan         String?  @map("new_plan")
  amount          Decimal? @db.Decimal(10, 2)
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@index([createdAt])
  @@map("subscription_history")
}

model EmailLog {
  id            String   @id @default(uuid())
  recipient     String
  subject       String
  status        String   // SENT, FAILED, QUEUED, BOUNCED
  messageId     String?  @map("message_id")
  errorMessage  String?  @map("error_message") @db.Text
  metadata      Json?    // Additional data like template name, variables
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

// ============================================
// System Settings (Super Admin)
// ============================================

model SystemSettings {
  id                       String   @id @default(uuid())
  key                      String   @unique // general, email, security, integrations
  value                    Json     // JSON object with all settings for this category
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model EmailTemplate {
  id            String   @id @default(uuid())
  name          String   // Human readable name
  slug          String   @unique // welcome, password-reset, sync-complete, new-lead
  subject       String
  htmlContent   String   @map("html_content") @db.Text
  textContent   String?  @map("text_content") @db.Text
  variables     String[] @default([]) // Available template variables like firstName, siteName
  description   String?  @db.Text // Template usage description
  isActive      Boolean  @default(true) @map("is_active")
  isSystem      Boolean  @default(false) @map("is_system") // System templates can't be deleted
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}