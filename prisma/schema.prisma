// Production-level Prisma Schema for Dealers Face
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Account Management
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  phone         String?
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // UTM Source Tracking - Capture how users discovered us
  utmSource     String? @map("utm_source") // e.g., google, facebook, referral
  utmMedium     String? @map("utm_medium") // e.g., cpc, social, email
  utmCampaign   String? @map("utm_campaign") // e.g., spring_sale, launch
  utmTerm       String? @map("utm_term") // Search keyword
  utmContent    String? @map("utm_content") // Ad variant identifier
  referralCode  String? @map("referral_code") // Referral tracking
  signupIp      String? @map("signup_ip") // IP at registration
  signupCountry String? @map("signup_country") // Country at registration

  // IntelliCeil Session Tracking
  lastActiveAt     DateTime? @map("last_active_at")
  loginCount       Int       @default(0) @map("login_count")
  currentSessionId String?   @map("current_session_id")
  lastIpAddress    String?   @map("last_ip_address")
  lastUserAgent    String?   @map("last_user_agent")
  loginMethod      String?   @map("login_method") // 'email', 'google', 'facebook'
  visitHeatScore   Int       @default(0) @map("visit_heat_score") // Frequency heat: 0-100

  // Two-Factor Authentication
  twoFactorEnabled     Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?  @map("two_factor_secret")
  twoFactorBackupCodes String[] @default([]) @map("two_factor_backup_codes")

  // NOTE: The following fields were removed because they don't exist in production DB
  // Run `npx prisma migrate deploy` on production to add them back
  // profilePicture, fbUsername, fbPassword, fb2faCodes, fbLastSync
  // facebookId, facebookAccessToken, facebookTokenExpiry

  // Relations
  accountUsers        AccountUser[]
  facebookProfiles    FacebookProfile[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  apiKeys             ApiKey[]
  assignedLeads       Lead[]               @relation("AssignedLeads")
  salesRepMappings    SalesRepMapping[]
  leadActivities      LeadActivity[]
  dealerAccount       DealerAccount?
  sentInvitations     TeamInvitation[]     @relation("InvitedBy")
  fbmPostLogs         FBMPostLog[]
  iaiSoldiers         IAISoldier[]
  trainingSessions    TrainingSession[]
  userSessions        UserSession[]
  iaiInstances        IAIInstance[]

  @@map("users")
}

model Account {
  id                 String    @id @default(uuid())
  name               String
  dealershipName     String?   @map("dealership_name")
  address            String?
  city               String?
  state              String?
  zip                String?
  phone              String?
  website            String?
  logoUrl            String?   @map("logo_url")
  isActive           Boolean   @default(true) @map("is_active")
  // Billing & Subscription
  stripeCustomerId   String?   @unique @map("stripe_customer_id")
  subscriptionPlanId String?   @map("subscription_plan_id")
  subscriptionStatus String    @default("trial") @map("subscription_status") // trial, active, past_due, canceled, paused
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  trialEndsAt        DateTime? @map("trial_ends_at")
  activeUserCount    Int       @default(0) @map("active_user_count")
  extraUserCharge    Decimal   @default(0) @map("extra_user_charge") @db.Decimal(10, 2)

  // FTP Configuration
  ftpHost     String? @map("ftp_host")
  ftpPort     Int?    @default(21) @map("ftp_port")
  ftpUsername String? @map("ftp_username")
  ftpPassword String? @map("ftp_password") // Encrypted
  csvPath     String? @map("csv_path")

  // Sync Settings
  autoSync     Boolean @default(true) @map("auto_sync")
  syncInterval Int     @default(3) @map("sync_interval") // hours

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accountUsers      AccountUser[]
  vehicles          Vehicle[]
  ftpConfigurations FtpConfiguration[]
  syncJobs          SyncJob[]
  facebookProfiles  FacebookProfile[]
  facebookGroups    FacebookGroup[]
  settings          AccountSettings?
  subscriptionPlan  SubscriptionPlan?  @relation(fields: [subscriptionPlanId], references: [id])
  payments          Payment[]
  invoices          Invoice[]
  apiKeys           ApiKey[]
  adfConfiguration  ADFConfiguration?
  leads             Lead[]
  teamInvitations   TeamInvitation[]
  pixelEvents       PixelEvent[]
  fbmPostLogs       FBMPostLog[]
  iaiSoldiers       IAISoldier[]
  iaiActivityLogs   IAIActivityLog[]
  // New Session-Based Auth Relations
  fbSessions        FbSession[]
  fbTotpSecret      FbTotpSecret?
  scheduledTasks    ScheduledTask[]
  iaiInstances      IAIInstance[]

  @@map("accounts")
}

// Role enum for AccountUser
enum UserRole {
  SUPER_ADMIN // Company owner - full system access
  ACCOUNT_OWNER // Dealership owner - full account access
  ADMIN // Account admin - manage users, settings, templates
  SALES_REP // Sales representative - personal posting only
  VIEWER // Read-only access
}

model AccountUser {
  id          String   @id @default(uuid())
  accountId   String   @map("account_id")
  userId      String   @map("user_id")
  role        UserRole @default(SALES_REP)
  permissions Json? // Custom permissions override
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@map("account_users")
}

// Team invitation for pending invites
enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELED
}

model TeamInvitation {
  id          String           @id @default(uuid())
  accountId   String           @map("account_id")
  email       String
  firstName   String?          @map("first_name")
  lastName    String?          @map("last_name")
  role        UserRole         @default(SALES_REP)
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  invitedById String           @map("invited_by_id")
  expiresAt   DateTime         @map("expires_at")
  acceptedAt  DateTime?        @map("accepted_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  invitedBy User    @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([email])
  @@index([token])
  @@index([accountId])
  @@map("team_invitations")
}

model AccountSettings {
  id                 String  @id @default(uuid())
  accountId          String  @unique @map("account_id")
  autoSyncEnabled    Boolean @default(true) @map("auto_sync_enabled")
  syncIntervalHours  Int     @default(3) @map("sync_interval_hours")
  postsPerRun        Int     @default(1) @map("posts_per_run")
  autoMarkSold       Boolean @default(true) @map("auto_mark_sold")
  autoUpdatePrice    Boolean @default(true) @map("auto_update_price")
  includeStockNumber Boolean @default(true) @map("include_stock_number")
  useAiDescription   Boolean @default(false) @map("use_ai_description")
  customDescription  String? @map("custom_description") @db.Text
  vehicleCategory    String  @default("Car/Truck") @map("vehicle_category")
  emojiSuffix        String  @default("ðŸ¤˜") @map("emoji_suffix")
  mileageUnit        String  @default("Miles") @map("mileage_unit")

  // Notification settings
  emailSyncComplete Boolean @default(true) @map("email_sync_complete")
  emailSyncError    Boolean @default(true) @map("email_sync_error")
  emailNewLead      Boolean @default(true) @map("email_new_lead")
  pushNotifications Boolean @default(false) @map("push_notifications")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account         Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  postingSettings PostingSettings?

  @@map("account_settings")
}

// ============================================
// Facebook Auto-Posting Settings (like Glo3D)
// ============================================

model PostingSettings {
  id                String @id @default(uuid())
  accountSettingsId String @unique @map("account_settings_id")

  // Post Schedule - Days
  postOnSunday    Boolean @default(true) @map("post_on_sunday")
  postOnMonday    Boolean @default(true) @map("post_on_monday")
  postOnTuesday   Boolean @default(true) @map("post_on_tuesday")
  postOnWednesday Boolean @default(true) @map("post_on_wednesday")
  postOnThursday  Boolean @default(true) @map("post_on_thursday")
  postOnFriday    Boolean @default(true) @map("post_on_friday")
  postOnSaturday  Boolean @default(true) @map("post_on_saturday")

  // Post Schedule - Hours
  postFromHour  Int @default(8) @map("post_from_hour") // 8 AM
  postUntilHour Int @default(20) @map("post_until_hour") // 8 PM

  // Posting Frequency
  postIntervalMinutes Int @default(20) @map("post_interval_minutes") // Post every X minutes
  dailyPostLimit      Int @default(0) @map("daily_post_limit") // 0 = unlimited

  // Posting Priority
  postingPriority String @default("descending") @map("posting_priority") // ascending (oldest first) or descending (newest first)

  // Content Settings
  includeVideos Boolean @default(true) @map("include_videos")
  videoSource   String  @default("videotour") @map("video_source") // walkaround, videotour

  // Vehicle Condition Template
  conditionTemplate String? @map("condition_template") @db.Text

  // Location Settings
  postingLocation String? @map("posting_location") // Address override
  postingRadius   Int     @default(40) @map("posting_radius") // miles

  // Auto-Renew Settings (refresh existing listings)
  autoRenewEnabled   Boolean @default(true) @map("auto_renew_enabled")
  renewFrequencyDays Int     @default(7) @map("renew_frequency_days")

  // Auto-Repost Settings (relist after deletion/expiration)
  autoRepostEnabled   Boolean @default(true) @map("auto_repost_enabled")
  repostFrequencyDays Int     @default(30) @map("repost_frequency_days")

  // Price Update Settings
  autoUpdatePrices     Boolean @default(true) @map("auto_update_prices")
  priceChangeThreshold Decimal @default(100) @map("price_change_threshold") @db.Decimal(10, 2) // Min change to trigger update

  // Status Tracking
  isActive   Boolean   @default(true) @map("is_active")
  lastPostAt DateTime? @map("last_post_at")
  postsToday Int       @default(0) @map("posts_today")
  totalPosts Int       @default(0) @map("total_posts")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accountSettings AccountSettings @relation(fields: [accountSettingsId], references: [id], onDelete: Cascade)

  @@map("posting_settings")
}

// ============================================
// Facebook Integration
// ============================================

model FacebookProfile {
  id               String    @id @default(uuid())
  accountId        String    @map("account_id")
  userId           String    @map("user_id")
  pageId           String    @map("page_id") // Facebook Page ID
  pageName         String    @map("page_name")
  category         String    @default("Automotive") // Page category
  facebookUserId   String    @map("facebook_user_id")
  facebookUserName String?   @map("facebook_user_name")
  accessToken      String    @map("access_token") @db.Text
  refreshToken     String?   @map("refresh_token") @db.Text
  tokenExpiresAt   DateTime  @map("token_expires_at")
  isActive         Boolean   @default(true) @map("is_active")
  lastSyncAt       DateTime? @map("last_sync_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  account Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts   FacebookPost[]

  @@unique([accountId, pageId])
  @@map("facebook_profiles")
}

model FacebookGroup {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  groupId      String    @map("group_id") // Facebook Group ID
  name         String
  url          String?
  memberCount  Int?      @map("member_count")
  isActive     Boolean   @default(true) @map("is_active")
  autoPost     Boolean   @default(false) @map("auto_post")
  lastPostedAt DateTime? @map("last_posted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, groupId])
  @@map("facebook_groups")
}

model FacebookPost {
  id            String    @id @default(uuid())
  vehicleId     String    @map("vehicle_id")
  profileId     String    @map("profile_id")
  postId        String?   @map("post_id") // Facebook post ID
  message       String?   @db.Text
  status        String    @default("pending") // PENDING, ACTIVE, FAILED, DELETED
  errorMessage  String?   @map("error_message") @db.Text
  postUrl       String?   @map("post_url")
  postedAt      DateTime? @map("posted_at")
  deletedAt     DateTime? @map("deleted_at")
  lastUpdatedAt DateTime? @map("last_updated_at")
  retryCount    Int       @default(0) @map("retry_count")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  profile FacebookProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([profileId])
  @@map("facebook_posts")
}

// ============================================
// Facebook Pixel Tracking
// ============================================

model PixelEvent {
  id        String  @id @default(uuid())
  accountId String  @map("account_id")
  vehicleId String? @map("vehicle_id")

  // Event Details
  eventType String @map("event_type") // ViewContent, InitiateCheckout, Lead, Purchase
  eventId   String @map("event_id") // Unique event ID
  eventData Json   @map("event_data") // Full pixel event data
  source    String @default("unknown") // marketplace_post, website, app

  // User Info (anonymized)
  userAgent String? @map("user_agent")
  ipHash    String? @map("ip_hash")

  // Timestamps
  firedAt   DateTime? @map("fired_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  account Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([accountId])
  @@index([vehicleId])
  @@index([eventType])
  @@index([createdAt])
  @@map("pixel_events")
}

// ============================================
// Vehicle Management
// ============================================

model Vehicle {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Identifiers
  vin         String
  stockNumber String? @map("stock_number")
  dealerId    String? @map("dealer_id")

  // Basic Info
  year      Int
  make      String
  model     String
  trim      String?
  bodyStyle String? @map("body_style")
  bodyType  String? @map("body_type")

  // Pricing
  price          Decimal? @db.Decimal(10, 2) // Primary price field
  listPrice      Decimal? @map("list_price") @db.Decimal(10, 2)
  specialPrice   Decimal? @map("special_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)
  wholesalePrice Decimal? @map("wholesale_price") @db.Decimal(10, 2)

  // Specifications
  mileage           Int?
  exteriorColor     String? @map("exterior_color")
  exteriorColorCode String? @map("exterior_color_code")
  interiorColor     String? @map("interior_color")
  interiorColorCode String? @map("interior_color_code")
  interiorMaterial  String? @map("interior_material")

  // Engine & Drivetrain
  engineDescription  String? @map("engine_description")
  engineDisplacement String? @map("engine_displacement")
  cylinders          String?
  drivetrain         String?
  transmission       String?
  transmissionType   String? @map("transmission_type")
  fuelType           String? @map("fuel_type")
  cityMpg            Int?    @map("city_mpg")
  hwyMpg             Int?    @map("hwy_mpg")

  // Facebook Marketplace Required Fields
  titleStatus   String? @map("title_status") // clean, salvage, rebuilt, lemon, parts_only, missing
  numberOfDoors Int?    @map("number_of_doors") // 2, 3, 4, 5
  numberOfSeats Int?    @map("number_of_seats") // 2-8+
  vehicleType   String? @map("vehicle_type") // car_truck, motorcycle, powersport, rv_camper, boat, commercial
  sellerType    String? @map("seller_type") // dealer, private

  // Status
  isNew            Boolean @default(false) @map("is_new")
  factoryCertified Boolean @default(false) @map("factory_certified")
  dealerCertified  Boolean @default(false) @map("dealer_certified")
  status           String  @default("active") // active, sold, pending, hidden

  // Descriptions
  title             String?
  description       String? @db.Text
  dealerComments    String? @map("dealer_comments") @db.Text
  optionDescription String? @map("option_description") @db.Text
  optionCodes       String? @map("option_codes") @db.Text

  // Metadata
  instockDate      DateTime? @map("instock_date")
  lastModifiedDate DateTime? @map("last_modified_date")
  videoUrl         String?   @map("video_url")
  imageUrls        String[]  @default([]) @map("image_urls") // Array of image URLs
  source           String    @default("MANUAL") // MANUAL, FTP, API

  // Tracking
  lastSyncedAt DateTime? @map("last_synced_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  photos        VehiclePhoto[]
  facebookPosts FacebookPost[]
  leads         Lead[]
  pixelEvents   PixelEvent[]
  fbmPostLogs   FBMPostLog[]

  @@unique([accountId, vin])
  @@index([accountId, status])
  @@index([vin])
  @@index([stockNumber])
  @@map("vehicles")
}

model VehiclePhoto {
  id           String   @id @default(uuid())
  vehicleId    String   @map("vehicle_id")
  url          String
  displayOrder Int      @default(0) @map("display_order")
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_photos")
}

// ============================================
// Data Sync & FTP
// ============================================

model FtpConfiguration {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  name         String
  host         String
  port         Int       @default(21)
  username     String
  password     String // Encrypted in application
  path         String    @default("/")
  protocol     String    @default("ftp") // ftp, sftp, ftps
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastTestedAt DateTime? @map("last_tested_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("ftp_configurations")
}

model SyncJob {
  id                 String    @id @default(uuid())
  accountId          String    @map("account_id")
  triggeredBy        String?   @map("triggered_by") // User ID who triggered manual sync
  status             String    @default("pending") // PENDING, PROCESSING, COMPLETED, FAILED
  type               String    @default("auto") // auto, manual
  recordsImported    Int       @default(0) @map("records_imported")
  recordsUpdated     Int       @default(0) @map("records_updated")
  recordsFailed      Int       @default(0) @map("records_failed")
  vehiclesAdded      Int       @default(0) @map("vehicles_added")
  vehiclesUpdated    Int       @default(0) @map("vehicles_updated")
  vehiclesMarkedSold Int       @default(0) @map("vehicles_marked_sold")
  errorMessage       String?   @map("error_message") @db.Text
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
  @@map("sync_jobs")
}

// ============================================
// Security & Audit
// ============================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String // Key identifier (e.g., "Chrome Extension - Desktop")
  keyHash     String    @unique @map("key_hash") // SHA256 hash of the key
  userId      String    @map("user_id")
  accountId   String    @map("account_id")
  permissions String[]  @default([]) // Array of permissions
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@map("api_keys")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String // info, warning, error, success
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ============================================
// Subscription & Billing Management
// ============================================

model SubscriptionPlan {
  id              String  @id @default(uuid())
  name            String  @unique // "Starter", "Growth", "Pro", "Enterprise Lifetime"
  slug            String  @unique @default("") // URL-friendly identifier
  description     String? @db.Text // Plan description
  stripePriceId   String? @unique @map("stripe_price_id")
  stripeProductId String? @map("stripe_product_id")
  basePrice       Decimal @map("base_price") @db.Decimal(10, 2) // Monthly price
  billingInterval String  @map("billing_interval") // "monthly", "yearly", "lifetime"
  includedUsers   Int     @map("included_users") // 10, 25, unlimited (-1)
  extraUserPrice  Decimal @map("extra_user_price") @db.Decimal(10, 2) // Price per extra user
  maxVehicles     Int     @default(-1) @map("max_vehicles") // -1 = unlimited
  maxPosts        Int     @default(-1) @map("max_posts") // -1 = unlimited posts per month
  features        Json? // JSON array of feature strings
  isActive        Boolean @default(true) @map("is_active")
  isPopular       Boolean @default(false) @map("is_popular") // Highlight as popular plan
  displayOrder    Int     @default(0) @map("display_order")

  // Lifetime plan specifics
  lifetimeDuration Int?     @map("lifetime_duration") // In years (e.g., 4)
  renewalPrice     Decimal? @map("renewal_price") @db.Decimal(10, 2) // Price to renew lifetime
  revertToPlanId   String?  @map("revert_to_plan_id") // Plan ID to revert after lifetime expires

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts      Account[]
  revertPlan    SubscriptionPlan?  @relation("PlanReversion", fields: [revertToPlanId], references: [id])
  revertedPlans SubscriptionPlan[] @relation("PlanReversion")

  @@map("subscription_plans")
}

model Payment {
  id              String    @id @default(uuid())
  accountId       String    @map("account_id")
  stripePaymentId String    @unique @map("stripe_payment_id")
  stripeInvoiceId String?   @map("stripe_invoice_id")
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("usd")
  status          String // succeeded, pending, failed, refunded
  paymentMethod   String?   @map("payment_method") // card, bank_transfer, etc.
  description     String?   @db.Text
  metadata        Json? // Extra data from Stripe
  paidAt          DateTime? @map("paid_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  account Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [stripeInvoiceId], references: [stripeInvoiceId])

  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Invoice {
  id              String  @id @default(uuid())
  accountId       String  @map("account_id")
  stripeInvoiceId String  @unique @map("stripe_invoice_id")
  invoiceNumber   String? @unique @map("invoice_number")
  amountDue       Decimal @map("amount_due") @db.Decimal(10, 2)
  amountPaid      Decimal @map("amount_paid") @db.Decimal(10, 2)
  currency        String  @default("usd")
  status          String // draft, open, paid, void, uncollectible
  hostedUrl       String? @map("hosted_url") @db.Text
  pdfUrl          String? @map("pdf_url") @db.Text

  // Line items breakdown
  baseCharge      Decimal @default(0) @map("base_charge") @db.Decimal(10, 2)
  extraUserCharge Decimal @default(0) @map("extra_user_charge") @db.Decimal(10, 2)
  extraUserCount  Int     @default(0) @map("extra_user_count")

  periodStart DateTime  @map("period_start")
  periodEnd   DateTime  @map("period_end")
  dueDate     DateTime? @map("due_date")
  paidAt      DateTime? @map("paid_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([accountId])
  @@index([status])
  @@map("invoices")
}

model SubscriptionHistory {
  id           String   @id @default(uuid())
  accountId    String   @map("account_id")
  planId       String?  @map("plan_id")
  planName     String   @map("plan_name")
  action       String // created, upgraded, downgraded, canceled, renewed, expired
  previousPlan String?  @map("previous_plan")
  newPlan      String?  @map("new_plan")
  amount       Decimal? @db.Decimal(10, 2)
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@index([createdAt])
  @@map("subscription_history")
}

model EmailLog {
  id           String  @id @default(uuid())
  recipient    String
  subject      String
  status       String // QUEUED, SENDING, SENT, DELIVERED, BOUNCED, FAILED, DEFERRED
  messageId    String? @map("message_id")
  errorMessage String? @map("error_message") @db.Text
  metadata     Json? // Additional data like template name, variables

  // MTA Tracking
  mtaMessageId String? @map("mta_message_id") // Local MTA message ID
  mtaResponse  String? @map("mta_response") @db.Text // MTA response

  // Delivery Tracking
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  bouncedAt   DateTime? @map("bounced_at")

  // Engagement Tracking
  openedAt   DateTime? @map("opened_at")
  openCount  Int       @default(0) @map("open_count")
  clickedAt  DateTime? @map("clicked_at")
  clickCount Int       @default(0) @map("click_count")

  // Bounce/Complaint Info
  bounceType   String?   @map("bounce_type") // HARD, SOFT
  bounceReason String?   @map("bounce_reason") @db.Text
  isComplaint  Boolean   @default(false) @map("is_complaint")
  complainedAt DateTime? @map("complained_at")

  // Retry Management
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  nextRetryAt DateTime? @map("next_retry_at")

  // Reference
  accountId    String? @map("account_id")
  userId       String? @map("user_id") // Sent by
  templateSlug String? @map("template_slug")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@index([accountId])
  @@index([messageId])
  @@map("email_logs")
}

// Email Queue - For reliable email delivery
model EmailQueue {
  id String @id @default(uuid())

  // Email Details
  fromEmail String   @map("from_email")
  fromName  String?  @map("from_name")
  toEmail   String   @map("to_email")
  toName    String?  @map("to_name")
  ccEmails  String[] @default([]) @map("cc_emails")
  bccEmails String[] @default([]) @map("bcc_emails")
  replyTo   String?  @map("reply_to")

  // Content
  subject     String
  htmlContent String  @map("html_content") @db.Text
  textContent String? @map("text_content") @db.Text
  headers     Json? // Custom headers including DKIM signature

  // Tracking
  trackingId  String  @unique @map("tracking_id") // For open/click tracking
  trackOpens  Boolean @default(true) @map("track_opens")
  trackClicks Boolean @default(true) @map("track_clicks")

  // Status
  status   String @default("PENDING") // PENDING, PROCESSING, SENT, FAILED, DEFERRED
  priority Int    @default(5) // 1-10 (1 = highest)

  // Delivery Tracking
  messageId    String? @map("message_id")
  mtaMessageId String? @map("mta_message_id")
  mtaResponse  String? @map("mta_response") @db.Text
  errorMessage String? @map("error_message") @db.Text

  // Retry Logic
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  nextAttemptAt DateTime? @map("next_attempt_at")
  lastAttemptAt DateTime? @map("last_attempt_at")
  lastError     String?   @map("last_error") @db.Text

  // Scheduling
  scheduledAt DateTime? @map("scheduled_at")
  processedAt DateTime? @map("processed_at")

  // Reference
  accountId    String? @map("account_id")
  userId       String? @map("user_id")
  templateSlug String? @map("template_slug")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status, priority, scheduledAt])
  @@index([nextAttemptAt])
  @@index([toEmail])
  @@index([trackingId])
  @@map("email_queue")
}

// Email Tracking Events
model EmailTrackingEvent {
  id         String  @id @default(uuid())
  trackingId String  @map("tracking_id")
  emailLogId String? @map("email_log_id")

  // Event Details
  eventType String // OPEN, CLICK, BOUNCE, COMPLAINT, DELIVERY

  // Click Tracking
  url        String? @db.Text // Alias for clickedUrl 
  clickedUrl String? @map("clicked_url") @db.Text

  // Bounce Info
  bounceType   String? @map("bounce_type")
  bounceReason String? @map("bounce_reason") @db.Text

  // Client Info
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text
  country   String?
  city      String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([trackingId])
  @@index([eventType])
  @@index([createdAt])
  @@map("email_tracking_events")
}

// Email Domain Configuration - DKIM/SPF/DMARC
model EmailDomain {
  id     String @id @default(uuid())
  domain String @unique

  // DKIM Configuration
  dkimSelector   String  @default("mail") @map("dkim_selector")
  dkimPrivateKey String? @map("dkim_private_key") @db.Text // Encrypted
  dkimPublicKey  String? @map("dkim_public_key") @db.Text
  dkimEnabled    Boolean @default(false) @map("dkim_enabled")

  // DNS Records (for verification guidance)
  spfRecord   String? @map("spf_record") @db.Text
  dmarcRecord String? @map("dmarc_record") @db.Text
  dkimRecord  String? @map("dkim_record") @db.Text

  // Verification Status
  spfVerified    Boolean   @default(false) @map("spf_verified")
  dkimVerified   Boolean   @default(false) @map("dkim_verified")
  dmarcVerified  Boolean   @default(false) @map("dmarc_verified")
  isVerified     Boolean   @default(false) @map("is_verified") // Overall verification
  lastVerifiedAt DateTime? @map("last_verified_at")

  // Domain Reputation
  reputation      Int   @default(100) // Alias for reputationScore
  reputationScore Int   @default(100) @map("reputation_score") // 0-100
  totalSent       Int   @default(0) @map("total_sent")
  totalBounced    Int   @default(0) @map("total_bounced")
  totalComplaints Int   @default(0) @map("total_complaints")
  bounceRate      Float @default(0) @map("bounce_rate")
  complaintRate   Float @default(0) @map("complaint_rate")

  // Rate Limiting
  hourlyLimit      Int       @default(100) @map("hourly_limit")
  dailyLimit       Int       @default(1000) @map("daily_limit")
  currentHourCount Int       @default(0) @map("current_hour_count")
  currentDayCount  Int       @default(0) @map("current_day_count")
  hourResetAt      DateTime? @map("hour_reset_at")
  dayResetAt       DateTime? @map("day_reset_at")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isDefault Boolean @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_domains")
}

// Email Suppression List - Bounces, Unsubscribes, Complaints
model EmailSuppression {
  id    String @id @default(uuid())
  email String @unique

  // Suppression Reason
  reason  String // BOUNCE_HARD, BOUNCE_SOFT, UNSUBSCRIBE, COMPLAINT, MANUAL
  details String? @db.Text

  // Source
  sourceType String? @map("source_type") // EMAIL_LOG_ID, WEBHOOK, MANUAL
  sourceId   String? @map("source_id")

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at") // For soft bounces

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([reason])
  @@map("email_suppressions")
}

// Email Statistics - Aggregated stats
model EmailStats {
  id String @id @default(uuid())

  // Time Period
  period      String // HOUR, DAY, WEEK, MONTH
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // Sending Stats
  totalQueued   Int @default(0) @map("total_queued")
  totalSent     Int @default(0) @map("total_sent")
  totalFailed   Int @default(0) @map("total_failed")
  totalDeferred Int @default(0) @map("total_deferred")

  // Delivery Stats
  totalDelivered Int @default(0) @map("total_delivered")
  totalBounced   Int @default(0) @map("total_bounced")
  hardBounces    Int @default(0) @map("hard_bounces")
  softBounces    Int @default(0) @map("soft_bounces")

  // Engagement Stats
  totalOpened       Int @default(0) @map("total_opened")
  uniqueOpens       Int @default(0) @map("unique_opens")
  totalClicked      Int @default(0) @map("total_clicked")
  uniqueClicks      Int @default(0) @map("unique_clicks")
  totalComplaints   Int @default(0) @map("total_complaints")
  totalUnsubscribes Int @default(0) @map("total_unsubscribes")

  // Rates
  deliveryRate  Float @default(0) @map("delivery_rate")
  bounceRate    Float @default(0) @map("bounce_rate")
  openRate      Float @default(0) @map("open_rate")
  clickRate     Float @default(0) @map("click_rate")
  complaintRate Float @default(0) @map("complaint_rate")

  // Domain
  domain    String?
  accountId String? @map("account_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([period, periodStart, domain, accountId])
  @@index([period, periodStart])
  @@index([domain])
  @@map("email_stats")
}

// ============================================
// System Settings (Super Admin)
// ============================================

model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique // general, email, security, integrations
  value     Json // JSON object with all settings for this category
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String // Human readable name
  slug        String   @unique // welcome, password-reset, sync-complete, new-lead
  subject     String
  htmlContent String   @map("html_content") @db.Text
  textContent String?  @map("text_content") @db.Text
  variables   String[] @default([]) // Available template variables like firstName, siteName
  description String?  @db.Text // Template usage description
  isActive    Boolean  @default(true) @map("is_active")
  isSystem    Boolean  @default(false) @map("is_system") // System templates can't be deleted
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

// ============================================
// ADF (Auto-Lead Data Format) Lead Management
// ============================================

// Lead Status Enum
enum LeadStatus {
  NEW // Just received, unassigned
  ASSIGNED // Assigned to a sales rep
  CONTACTED // Initial contact made
  QUALIFIED // Lead is qualified/interested
  APPOINTMENT // Appointment scheduled
  NEGOTIATING // In price negotiation
  WON // Sale completed
  LOST // Lead lost to competitor/no interest
  ARCHIVED // Old lead archived
}

// Lead Source Enum
enum LeadSource {
  FACEBOOK_MARKETPLACE
  FACEBOOK_PAGE
  WEBSITE
  WALK_IN
  PHONE
  EMAIL
  REFERRAL
  THIRD_PARTY
  ADF_IMPORT
  MANUAL
}

// Lead Priority Enum
enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model ADFConfiguration {
  id        String @id @default(uuid())
  accountId String @unique @map("account_id")

  // DMS Integration Settings
  dmsProvider String? @map("dms_provider") // DealerSocket, CDK, Reynolds, etc.
  dmsEndpoint String? @map("dms_endpoint") // ADF submission URL
  dmsUsername String? @map("dms_username")
  dmsPassword String? @map("dms_password") // Encrypted
  dmsApiKey   String? @map("dms_api_key") // Encrypted

  // Email Settings for ADF
  adfEmailEnabled       Boolean  @default(true) @map("adf_email_enabled")
  adfEmailRecipients    String[] @default([]) @map("adf_email_recipients")
  adfEmailSender        String?  @map("adf_email_sender") // Verified sender email
  adfEmailSubjectPrefix String   @default("[New Lead]") @map("adf_email_subject_prefix")

  // Auto Assignment Rules
  autoAssignEnabled Boolean @default(true) @map("auto_assign_enabled")
  roundRobinEnabled Boolean @default(false) @map("round_robin_enabled")
  defaultAssigneeId String? @map("default_assignee_id") // User ID for default assignment

  // AI Communication Settings
  aiAssistantEnabled Boolean @default(false) @map("ai_assistant_enabled")
  aiResponseTemplate String? @map("ai_response_template") @db.Text
  aiAutoResponse     Boolean @default(false) @map("ai_auto_response")
  aiDelayMinutes     Int     @default(5) @map("ai_delay_minutes") // Delay before AI responds

  // Lead Processing
  duplicateCheckEnabled Boolean @default(true) @map("duplicate_check_enabled")
  duplicateWindowHours  Int     @default(24) @map("duplicate_window_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account          Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  salesRepMappings SalesRepMapping[]

  @@map("adf_configurations")
}

// Sales Rep Mapping - Maps Facebook usernames to DMS sales rep IDs
model SalesRepMapping {
  id              String @id @default(uuid())
  configurationId String @map("configuration_id")
  userId          String @map("user_id") // Internal user ID

  // Facebook Identifiers
  facebookUsername    String? @map("facebook_username")
  facebookUserId      String? @map("facebook_user_id")
  facebookDisplayName String? @map("facebook_display_name")

  // DMS Identifiers
  dmsRepId    String? @map("dms_rep_id") // Sales rep ID in DMS
  dmsRepName  String? @map("dms_rep_name")
  dmsRepEmail String? @map("dms_rep_email")

  // Assignment Settings
  isActive       Boolean   @default(true) @map("is_active")
  maxLeadsPerDay Int?      @map("max_leads_per_day")
  leadCount      Int       @default(0) @map("lead_count")
  lastAssignedAt DateTime? @map("last_assigned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  configuration ADFConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([configurationId, userId])
  @@map("sales_rep_mappings")
}

// Lead - Main lead entity
model Lead {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Lead Identification
  leadNumber     String  @unique @map("lead_number") // Auto-generated lead ID
  externalLeadId String? @map("external_lead_id") // ID from external source

  // Status & Priority
  status   LeadStatus   @default(NEW)
  priority LeadPriority @default(MEDIUM)
  source   LeadSource   @default(MANUAL)

  // Assignment
  assignedToId String?   @map("assigned_to_id") // User ID of assigned sales rep
  assignedAt   DateTime? @map("assigned_at")

  // Customer Information
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  fullName  String? @map("full_name")
  email     String?
  phone     String?
  altPhone  String? @map("alt_phone")
  address   String?
  city      String?
  state     String?
  zip       String?
  country   String? @default("US")

  // Facebook Information
  facebookUserId       String? @map("facebook_user_id")
  facebookUsername     String? @map("facebook_username")
  facebookDisplayName  String? @map("facebook_display_name")
  facebookProfileUrl   String? @map("facebook_profile_url")
  facebookMessengerUrl String? @map("facebook_messenger_url")

  // Vehicle Interest
  vehicleId             String? @map("vehicle_id") // Link to interested vehicle
  interestedVehicle     String? @map("interested_vehicle") // Text description
  interestedYear        Int?    @map("interested_year")
  interestedMake        String? @map("interested_make")
  interestedModel       String? @map("interested_model")
  interestedVin         String? @map("interested_vin")
  interestedStockNumber String? @map("interested_stock_number")

  // Trade-In Information
  hasTradeIn   Boolean  @default(false) @map("has_trade_in")
  tradeYear    Int?     @map("trade_year")
  tradeMake    String?  @map("trade_make")
  tradeModel   String?  @map("trade_model")
  tradeVin     String?  @map("trade_vin")
  tradeMileage Int?     @map("trade_mileage")
  tradePayoff  Decimal? @map("trade_payoff") @db.Decimal(10, 2)

  // Financial
  budgetMin    Decimal? @map("budget_min") @db.Decimal(10, 2)
  budgetMax    Decimal? @map("budget_max") @db.Decimal(10, 2)
  creditRating String?  @map("credit_rating")
  preApproved  Boolean  @default(false) @map("pre_approved")

  // Comments & Notes
  customerComments String? @map("customer_comments") @db.Text
  internalNotes    String? @map("internal_notes") @db.Text

  // ADF Tracking
  adfSent           Boolean   @default(false) @map("adf_sent")
  adfSentAt         DateTime? @map("adf_sent_at")
  adfMessageId      String?   @map("adf_message_id")
  adfDeliveryStatus String?   @map("adf_delivery_status") // PENDING, SENT, DELIVERED, FAILED
  adfErrorMessage   String?   @map("adf_error_message") @db.Text

  // Tracking
  lastContactedAt DateTime? @map("last_contacted_at")
  nextFollowUpAt  DateTime? @map("next_follow_up_at")
  appointmentAt   DateTime? @map("appointment_at")
  closedAt        DateTime? @map("closed_at")
  closedReason    String?   @map("closed_reason")

  // Metadata
  rawAdfXml String? @map("raw_adf_xml") @db.Text // Original ADF XML
  metadata  Json? // Additional data

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account        Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignedTo     User?               @relation("AssignedLeads", fields: [assignedToId], references: [id], onDelete: SetNull)
  vehicle        Vehicle?            @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  communications LeadCommunication[]
  activities     LeadActivity[]
  adfSubmissions ADFSubmission[]
  messages       Message[]

  @@index([accountId, status])
  @@index([assignedToId])
  @@index([email])
  @@index([phone])
  @@index([createdAt])
  @@map("leads")
}

// Lead Communication - Track all communications
model LeadCommunication {
  id     String @id @default(uuid())
  leadId String @map("lead_id")

  // Communication Type
  type      String // EMAIL, SMS, PHONE, FACEBOOK_MESSAGE, AI_RESPONSE
  direction String // INBOUND, OUTBOUND

  // Content
  subject     String?
  content     String  @db.Text
  contentHtml String? @map("content_html") @db.Text

  // Metadata
  senderId       String? @map("sender_id") // User ID or system
  senderName     String? @map("sender_name")
  recipientEmail String? @map("recipient_email")
  recipientPhone String? @map("recipient_phone")

  // Delivery Status
  status       String    @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  readAt       DateTime? @map("read_at")
  errorMessage String?   @map("error_message") @db.Text

  // AI Generated
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiModel       String? @map("ai_model")
  aiPrompt      String? @map("ai_prompt") @db.Text

  // External References
  externalMessageId String? @map("external_message_id")
  facebookMessageId String? @map("facebook_message_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([type])
  @@index([createdAt])
  @@map("lead_communications")
}

// Lead Activity - Track all lead activities
model LeadActivity {
  id     String  @id @default(uuid())
  leadId String  @map("lead_id")
  userId String? @map("user_id")

  // Activity Type
  type        String // STATUS_CHANGE, ASSIGNED, NOTE_ADDED, COMMUNICATION, ADF_SENT, etc.
  title       String
  description String? @db.Text

  // Change Tracking
  previousValue String? @map("previous_value")
  newValue      String? @map("new_value")

  // Metadata
  metadata Json?
  isSystem Boolean @default(false) @map("is_system")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([type])
  @@index([createdAt])
  @@map("lead_activities")
}

// ADF Submission - Track ADF sends to DMS
model ADFSubmission {
  id        String @id @default(uuid())
  leadId    String @map("lead_id")
  accountId String @map("account_id")

  // Submission Type
  method   String // EMAIL, API, HTTP_POST
  endpoint String? // DMS endpoint URL

  // ADF Content
  adfXml     String @map("adf_xml") @db.Text
  adfVersion String @default("1.0") @map("adf_version")

  // Delivery Status
  status        String  @default("PENDING") // PENDING, SENT, DELIVERED, ACKNOWLEDGED, FAILED
  statusMessage String? @map("status_message") @db.Text

  // Response
  responseCode Int?    @map("response_code")
  responseBody String? @map("response_body") @db.Text
  dmsLeadId    String? @map("dms_lead_id") // Lead ID returned by DMS

  // Email Specific
  emailTo             String[] @default([]) @map("email_to")
  emailMessageId      String?  @map("email_message_id")
  emailDeliveryStatus String?  @map("email_delivery_status")

  // Retry
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  nextRetryAt DateTime? @map("next_retry_at")

  // Timestamps
  sentAt         DateTime? @map("sent_at")
  deliveredAt    DateTime? @map("delivered_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  failedAt       DateTime? @map("failed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("adf_submissions")
}

// ============================================
// Chrome Extension Integration
// ============================================

// Task queue for Chrome Extension automation
model ExtensionTask {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Task Type
  type     String // post_vehicle, scrape_inbox, scrape_conversation, respond_lead
  status   String @default("pending") // pending, processing, completed, failed, cancelled
  priority Int    @default(5) // 1-10, higher = more urgent

  // Task Data
  data   Json? // Command data, vehicle info, etc
  result Json? // Task execution result

  // Related Entities
  vehicleId String? @map("vehicle_id")
  leadId    String? @map("lead_id")

  // Scheduling
  scheduledFor DateTime? @map("scheduled_for")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")

  // Retry
  retryCount Int @default(0) @map("retry_count")
  maxRetries Int @default(3) @map("max_retries")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  fbmPostLog FBMPostLog?

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([scheduledFor])
  @@map("extension_tasks")
}

// ============================================
// FBM Post Tracking & Debugging
// ============================================

// Comprehensive log for all Facebook Marketplace posting attempts
model FBMPostLog {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  vehicleId String @map("vehicle_id")
  userId    String @map("user_id") // Who triggered the post

  // Post Method
  method      String // iai, soldier, hybrid
  triggerType String @map("trigger_type") // manual, auto_post, scheduled, retry

  // Status Tracking
  status String @default("initiated") // initiated, queued, processing, posting, verifying, completed, failed, cancelled
  stage  String @default("init") // init, task_created, extension_received, fb_navigated, form_filling, photo_upload, submit, verify

  // Task Reference
  extensionTaskId String? @unique @map("extension_task_id")
  facebookPostId  String? @map("facebook_post_id") // Our FacebookPost record ID
  fbPostId        String? @map("fb_post_id") // Actual FB post ID if successful

  // Timing
  initiatedAt  DateTime  @default(now()) @map("initiated_at")
  queuedAt     DateTime? @map("queued_at")
  processingAt DateTime? @map("processing_at")
  completedAt  DateTime? @map("completed_at")
  duration     Int? // Total duration in seconds

  // Result & Errors
  success      Boolean @default(false)
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message") @db.Text
  errorDetails Json?   @map("error_details")

  // Debug Data
  vehicleData  Json? @map("vehicle_data") // Snapshot of vehicle at post time
  requestData  Json? @map("request_data") // What was sent
  responseData Json? @map("response_data") // What was received
  stageHistory Json? @map("stage_history") // Array of stage transitions with timestamps

  // Retry Info
  attemptNumber Int       @default(1) @map("attempt_number")
  parentLogId   String?   @map("parent_log_id") // If this is a retry, reference original
  retryCount    Int       @default(0) @map("retry_count")
  nextRetryAt   DateTime? @map("next_retry_at")

  // Risk Assessment
  riskLevel   String @default("low") // low, medium, high, critical
  riskFactors Json?  @map("risk_factors") // Array of risk factors

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  vehicle       Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  extensionTask ExtensionTask? @relation(fields: [extensionTaskId], references: [id], onDelete: SetNull)
  parentLog     FBMPostLog?    @relation("RetryChain", fields: [parentLogId], references: [id], onDelete: SetNull)
  retryLogs     FBMPostLog[]   @relation("RetryChain")
  events        FBMPostEvent[]

  @@index([accountId])
  @@index([vehicleId])
  @@index([userId])
  @@index([method])
  @@index([status])
  @@index([triggerType])
  @@index([success])
  @@index([riskLevel])
  @@index([createdAt])
  @@map("fbm_post_logs")
}

// Granular events for each posting attempt
model FBMPostEvent {
  id        String @id @default(uuid())
  postLogId String @map("post_log_id")

  // Event Info
  eventType String @map("event_type") // stage_change, error, warning, info, debug
  stage     String // Current stage when event occurred
  message   String @db.Text
  details   Json? // Additional event details

  // Source
  source String @default("api") // api, extension, worker, system

  // Timestamps
  timestamp DateTime @default(now())

  // Relations
  postLog FBMPostLog @relation(fields: [postLogId], references: [id], onDelete: Cascade)

  @@index([postLogId])
  @@index([eventType])
  @@index([timestamp])
  @@map("fbm_post_events")
}

// AI-generated responses for approval
model AIResponse {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  leadId    String @map("lead_id")

  // Response Content
  responseText String @map("response_text") @db.Text
  responseType String @map("response_type") // initial, follow_up, price_negotiation, availability

  // Analysis
  conversationAnalysis Json? @map("conversation_analysis")
  confidence           Float @default(0)

  // Approval Status
  status     String    @default("pending") // pending, approved, rejected, sent
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")
  sentAt     DateTime? @map("sent_at")

  // Edit tracking
  wasEdited  Boolean @default(false) @map("was_edited")
  editedText String? @map("edited_text") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([leadId])
  @@index([status])
  @@map("ai_responses")
}

// Message history for conversation tracking
model Message {
  id                String  @id @default(uuid())
  leadId            String  @map("lead_id")
  facebookMessageId String? @map("facebook_message_id")

  // Content
  text       String  @db.Text
  sender     String // buyer name or "dealer"
  isOutgoing Boolean @default(false) @map("is_outgoing")

  // AI Analysis
  sentiment String? // positive, negative, neutral
  intent    String? // question, interest, negotiation, etc

  // Timestamps
  sentAt    DateTime @map("sent_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([leadId, facebookMessageId])
  @@index([leadId])
  @@index([sentAt])
  @@map("messages")
}

// Facebook session data for the extension
model FacebookSession {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Session cookies (encrypted)
  cookies   String @db.Text
  userAgent String @map("user_agent")

  // Session Status
  isValid       Boolean  @default(true) @map("is_valid")
  lastValidated DateTime @map("last_validated")
  lastActivity  DateTime @map("last_activity")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("facebook_sessions")
}

// DealerAccount for extension integration
model DealerAccount {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Business Info
  businessName    String? @map("business_name")
  businessAddress String? @map("business_address")
  businessPhone   String? @map("business_phone")

  // Facebook Connection
  facebookConnected Boolean @default(false) @map("facebook_connected")
  facebookUserId    String? @map("facebook_user_id")

  // Settings
  autoRespond   Boolean @default(false) @map("auto_respond")
  responseDelay Int     @default(30) @map("response_delay") // seconds

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dealer_accounts")
}

// ============================================
// AI CENTER - COMPREHENSIVE AI MANAGEMENT
// ============================================

// AI Provider Configuration
model AIProvider {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Provider Info
  name        String // anthropic, openai, google, meta, custom
  displayName String  @map("display_name")
  apiKey      String  @map("api_key") @db.Text // Encrypted
  apiEndpoint String? @map("api_endpoint") // For custom providers

  // Model Configuration
  defaultModel    String @map("default_model")
  availableModels Json   @map("available_models") // Array of model configs

  // Capabilities
  capabilities Json // { chat: true, vision: true, function_calling: true, etc }

  // Rate Limits
  maxTokensPerMinute   Int   @default(100000) @map("max_tokens_per_minute")
  maxRequestsPerMinute Int   @default(60) @map("max_requests_per_minute")
  currentUsage         Json? @map("current_usage") // { tokens: 0, requests: 0, resetAt: date }

  // Status
  isActive     Boolean   @default(true) @map("is_active")
  isDefault    Boolean   @default(false) @map("is_default")
  lastTested   DateTime? @map("last_tested")
  healthStatus String    @default("unknown") @map("health_status") // healthy, degraded, down, unknown

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  memories         AIMemory[]
  trainingSessions AITrainingSession[]
  conversations    AIConversation[]

  @@unique([accountId, name])
  @@index([accountId])
  @@index([isActive])
  @@map("ai_providers")
}

// AI Shared Memory - Persistent knowledge storage for each AI
model AIMemory {
  id         String @id @default(uuid())
  providerId String @map("provider_id")
  accountId  String @map("account_id")

  // Memory Type
  memoryType String @map("memory_type") // dealer_profile, inventory, customer_patterns, conversation_context, learned_responses, threat_patterns

  // Memory Content
  key        String
  value      Json
  embedding  Float[] // Vector embedding for semantic search
  confidence Float   @default(1.0)
  source     String? // Where this memory came from

  // Context
  context Json? // Related context/metadata
  tags    String[] @default([])

  // Importance & Decay
  importance   Float     @default(0.5) // 0-1, affects retrieval priority
  accessCount  Int       @default(0) @map("access_count")
  lastAccessed DateTime? @map("last_accessed")
  expiresAt    DateTime? @map("expires_at")

  // Versioning
  version           Int     @default(1)
  previousVersionId String? @map("previous_version_id")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  provider AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, memoryType, key])
  @@index([providerId])
  @@index([accountId])
  @@index([memoryType])
  @@index([tags])
  @@map("ai_memories")
}

// AI Training Session - Training history and progress
model AITrainingSession {
  id         String @id @default(uuid())
  providerId String @map("provider_id")
  accountId  String @map("account_id")

  // Training Info
  name         String
  description  String? @db.Text
  trainingType String  @map("training_type") // fbm_specialist, customer_service, inventory_expert, threat_detection, navigation

  // Training Data
  trainingData Json @map("training_data") // Training examples, prompts, etc
  datasetSize  Int  @map("dataset_size")

  // Training Configuration
  config Json // { epochs: 3, learning_rate: 0.001, batch_size: 32, etc }

  // Progress
  status      String @default("pending") // pending, in_progress, completed, failed, paused
  progress    Float  @default(0) // 0-100
  currentStep Int    @default(0) @map("current_step")
  totalSteps  Int    @map("total_steps")

  // Results
  metrics    Json? // { accuracy: 0.95, loss: 0.05, f1_score: 0.92, etc }
  evaluation Json? // Test results
  artifacts  Json? // Model weights, checkpoints, etc

  // Error Handling
  errorLog  Json?   @map("error_log")
  lastError String? @map("last_error") @db.Text

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  provider      AIProvider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  trainingData2 AITrainingData[]

  @@index([providerId])
  @@index([accountId])
  @@index([trainingType])
  @@index([status])
  @@map("ai_training_sessions")
}

// AI Training Data - Individual training examples
model AITrainingData {
  id        String @id @default(uuid())
  sessionId String @map("session_id")
  accountId String @map("account_id")

  // Data Type
  dataType String @map("data_type") // conversation, scenario, knowledge, threat_example
  category String // fbm_inquiry, price_negotiation, availability, complaint, threat, etc

  // Training Example
  input          String @db.Text // The input/prompt
  expectedOutput String @map("expected_output") @db.Text // Expected response
  context        Json? // Additional context

  // Quality
  quality    Float   @default(1.0) // 0-1, quality score
  isVerified Boolean @default(false) @map("is_verified")
  verifiedBy String? @map("verified_by")

  // Usage Stats
  usedInTraining Int    @default(0) @map("used_in_training")
  effectiveness  Float? // How well this example performed

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  session AITrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([accountId])
  @@index([category])
  @@index([dataType])
  @@map("ai_training_data")
}

// AI Conversation - Full conversation tracking with analysis
model AIConversation {
  id         String  @id @default(uuid())
  providerId String  @map("provider_id")
  accountId  String  @map("account_id")
  leadId     String? @map("lead_id")

  // Conversation Info
  conversationType String @map("conversation_type") // fbm_inquiry, support, negotiation, etc
  channel          String // facebook_marketplace, messenger, web_chat

  // Participants
  customerId   String? @map("customer_id")
  customerName String? @map("customer_name")
  agentMode    String  @map("agent_mode") // autonomous, supervised, manual

  // Context
  vehicleId     String? @map("vehicle_id")
  vehicleInfo   Json?   @map("vehicle_info")
  dealerContext Json?   @map("dealer_context")

  // Conversation State
  status      String @default("active") // active, paused, completed, escalated, flagged
  sentiment   String @default("neutral") // positive, neutral, negative, hostile
  intentStack Json   @default("[]") @map("intent_stack") // Current conversation intents

  // Metrics
  messageCount      Int    @default(0) @map("message_count")
  avgResponseTime   Float? @map("avg_response_time") // seconds
  satisfactionScore Float? @map("satisfaction_score")

  // Threat Assessment
  threatLevel String @default("none") @map("threat_level") // none, low, medium, high, critical
  threatFlags Json   @default("[]") @map("threat_flags")

  // Escalation
  isEscalated      Boolean   @default(false) @map("is_escalated")
  escalatedAt      DateTime? @map("escalated_at")
  escalatedTo      String?   @map("escalated_to")
  escalationReason String?   @map("escalation_reason") @db.Text

  // Resolution
  resolution      String? // sold, not_interested, follow_up, no_response, threat_ended
  resolutionNotes String? @map("resolution_notes") @db.Text

  // Timestamps
  startedAt     DateTime  @default(now()) @map("started_at")
  lastMessageAt DateTime? @map("last_message_at")
  endedAt       DateTime? @map("ended_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  provider AIProvider              @relation(fields: [providerId], references: [id])
  messages AIConversationMessage[]
  threats  AIThreat[]

  @@index([providerId])
  @@index([accountId])
  @@index([leadId])
  @@index([status])
  @@index([threatLevel])
  @@map("ai_conversations")
}

// AI Conversation Messages - Individual messages with full analysis
model AIConversationMessage {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")

  // Message Content
  role        String // user, assistant, system
  content     String @db.Text
  contentType String @default("text") @map("content_type") // text, image, link, attachment

  // Analysis
  intent     String? // question, statement, request, complaint, threat, etc
  sentiment  Float? // -1 to 1
  confidence Float? // AI confidence in response
  topics     String[] @default([])
  entities   Json? // Extracted entities { names, phones, vehicles, etc }

  // AI Processing
  tokensUsed     Int?    @map("tokens_used")
  modelUsed      String? @map("model_used")
  processingTime Float?  @map("processing_time") // ms

  // Memory Operations
  memoriesUsed    Json? @map("memories_used") // Which memories were accessed
  memoriesCreated Json? @map("memories_created") // New memories created

  // Actions Taken
  actions       Json? // { fetched_carfax: true, checked_inventory: true, etc }
  externalCalls Json? @map("external_calls") // API calls made

  // Threat Detection
  threatIndicators Json?   @map("threat_indicators")
  wasFlagged       Boolean @default(false) @map("was_flagged")

  // Human Review
  needsReview     Boolean @default(false) @map("needs_review")
  reviewedBy      String? @map("reviewed_by")
  reviewNotes     String? @map("review_notes") @db.Text
  wasEdited       Boolean @default(false) @map("was_edited")
  originalContent String? @map("original_content") @db.Text

  // Timestamps
  sentAt    DateTime @default(now()) @map("sent_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([sentAt])
  @@map("ai_conversation_messages")
}

// AI Threat Detection - Comprehensive threat tracking
model AIThreat {
  id             String  @id @default(uuid())
  conversationId String? @map("conversation_id")
  accountId      String  @map("account_id")

  // Threat Info
  threatType String @map("threat_type") // harassment, scam, fraud, violence, discrimination, spam, phishing, profanity, manipulation
  severity   String // low, medium, high, critical

  // Detection
  detectedAt      DateTime @map("detected_at")
  detectionMethod String   @map("detection_method") // pattern_match, ml_classifier, keyword, sentiment, behavioral
  confidence      Float    @default(0.5)

  // Evidence
  triggerContent String @map("trigger_content") @db.Text
  context        Json? // Surrounding context
  indicators     Json // List of threat indicators

  // Classification
  category    String // legal_threat, personal_attack, competitive_sabotage, etc
  subcategory String?
  tags        String[] @default([])

  // Response Taken
  responseTaken   String    @map("response_taken") // warning_issued, conversation_ended, user_blocked, escalated, ignored
  responseContent String?   @map("response_content") @db.Text
  responseAt      DateTime? @map("response_at")

  // Impact Assessment
  businessImpact String? @map("business_impact") // none, low, medium, high
  legalRisk      String? @map("legal_risk") // none, low, medium, high

  // Resolution
  status          String    @default("active") // active, resolved, escalated, false_positive
  resolvedBy      String?   @map("resolved_by")
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @map("resolution_notes") @db.Text

  // Learning
  addedToTraining Boolean @default(false) @map("added_to_training")
  patternId       String? @map("pattern_id") // Link to threat pattern

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  conversation AIConversation? @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
  @@index([accountId])
  @@index([threatType])
  @@index([severity])
  @@index([status])
  @@map("ai_threats")
}

// AI Threat Pattern - Learned threat detection patterns
model AIThreatPattern {
  id        String  @id @default(uuid())
  accountId String? @map("account_id") // null = global pattern

  // Pattern Info
  name        String
  description String? @db.Text
  threatType  String  @map("threat_type")
  severity    String

  // Detection Rules
  patternType String @map("pattern_type") // regex, keyword, semantic, behavioral, ml_classifier
  pattern     Json // The actual pattern definition
  examples    Json // Example matches

  // Effectiveness
  matchCount     Int    @default(0) @map("match_count")
  falsePositives Int    @default(0) @map("false_positives")
  accuracy       Float? // Calculated accuracy

  // Response Template
  defaultResponse    String? @map("default_response") @db.Text
  escalationRequired Boolean @default(false) @map("escalation_required")

  // Status
  isActive Boolean @default(true) @map("is_active")
  isGlobal Boolean @default(false) @map("is_global")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([threatType])
  @@index([isActive])
  @@map("ai_threat_patterns")
}

// AI Learning Pattern - General learning from interactions
model AILearningPattern {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Pattern Info
  patternType String @map("pattern_type") // response_success, customer_preference, negotiation_tactic, objection_handling
  category    String

  // Pattern Definition
  trigger  Json // What triggers this pattern
  response Json // Successful response pattern
  context  Json? // When to apply

  // Effectiveness
  successRate Float @map("success_rate") // 0-1
  sampleSize  Int   @map("sample_size")
  confidence  Float @default(0.5)

  // Usage
  usageCount Int       @default(0) @map("usage_count")
  lastUsed   DateTime? @map("last_used")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified")
  verifiedBy String? @map("verified_by")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([patternType])
  @@index([category])
  @@map("ai_learning_patterns")
}

// AI Task - Todo/Task management for AI operations
model AITask {
  id         String  @id @default(uuid())
  accountId  String  @map("account_id")
  providerId String? @map("provider_id")

  // Task Info
  title       String
  description String? @db.Text
  taskType    String  @map("task_type") // auto_respond, follow_up, inventory_update, carfax_fetch, listing_refresh, training, analysis

  // Assignment
  assignedTo String? @map("assigned_to") // AI provider or user
  assignedBy String? @map("assigned_by")

  // Priority & Scheduling
  priority        Int       @default(5) // 1-10
  dueAt           DateTime? @map("due_at")
  scheduledFor    DateTime? @map("scheduled_for")
  recurringConfig Json?     @map("recurring_config") // { interval: "daily", time: "09:00", etc }

  // Dependencies
  dependsOn String[] @default([]) @map("depends_on") // Task IDs this depends on
  blockedBy String[] @default([]) @map("blocked_by")

  // Execution
  status   String @default("pending") // pending, in_progress, completed, failed, cancelled, blocked
  progress Float  @default(0)

  // Task Data
  inputData  Json? @map("input_data")
  outputData Json? @map("output_data")

  // Results
  result   Json?
  errorLog Json? @map("error_log")

  // Autonomy
  autonomyLevel    String    @map("autonomy_level") // full, supervised, manual_approval
  requiresApproval Boolean   @default(false) @map("requires_approval")
  approvedBy       String?   @map("approved_by")
  approvedAt       DateTime? @map("approved_at")

  // Limits
  maxRetries Int  @default(3) @map("max_retries")
  retryCount Int  @default(0) @map("retry_count")
  timeout    Int? // seconds

  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([providerId])
  @@index([taskType])
  @@index([status])
  @@index([priority])
  @@index([dueAt])
  @@map("ai_tasks")
}

// AI Capability - Defines what the AI can do
model AICapability {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Capability Info
  name        String
  description String? @db.Text
  category    String // navigation, communication, data_access, external_api, file_operations

  // Permissions
  isEnabled        Boolean @default(true) @map("is_enabled")
  requiresApproval Boolean @default(false) @map("requires_approval")

  // Limits
  rateLimit    Int?  @map("rate_limit") // per hour
  dailyLimit   Int?  @map("daily_limit")
  monthlyLimit Int?  @map("monthly_limit")
  currentUsage Json? @map("current_usage")

  // Allowed Operations
  allowedOperations Json  @map("allowed_operations") // Specific operations allowed
  blockedOperations Json? @map("blocked_operations") // Explicitly blocked

  // Scope
  allowedUrls String[] @default([]) @map("allowed_urls") // For navigation
  blockedUrls String[] @default([]) @map("blocked_urls")
  allowedApis String[] @default([]) @map("allowed_apis") // For external calls

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([accountId, name])
  @@index([accountId])
  @@index([category])
  @@map("ai_capabilities")
}

// AI Audit Log - Complete audit trail of AI actions
model AIAuditLog {
  id         String  @id @default(uuid())
  accountId  String  @map("account_id")
  providerId String? @map("provider_id")

  // Action Info
  action   String // memory_read, memory_write, api_call, navigation, file_upload, response_sent, etc
  category String // memory, communication, navigation, file, external_api

  // Details
  target     String? // What was acted upon
  targetType String? @map("target_type") // memory, conversation, vehicle, lead, file
  targetId   String? @map("target_id")

  // Request/Response
  request  Json?
  response Json?

  // Context
  conversationId String? @map("conversation_id")
  taskId         String? @map("task_id")
  triggeredBy    String? @map("triggered_by") // What triggered this action

  // Results
  status       String // success, failed, blocked, rate_limited
  errorMessage String? @map("error_message") @db.Text

  // Performance
  duration   Float? // ms
  tokensUsed Int?   @map("tokens_used")

  // Security
  ipAddress   String? @map("ip_address")
  userAgent   String? @map("user_agent")
  wasBlocked  Boolean @default(false) @map("was_blocked")
  blockReason String? @map("block_reason")

  // Timestamps
  performedAt DateTime @default(now()) @map("performed_at")

  @@index([accountId])
  @@index([providerId])
  @@index([action])
  @@index([performedAt])
  @@index([status])
  @@map("ai_audit_logs")
}

// AI External Service Integration - Carfax, AutoCheck, etc
model AIExternalService {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Service Info
  name        String // carfax, autocheck, kbb, nada, edmunds
  displayName String @map("display_name")
  serviceType String @map("service_type") // vehicle_history, valuation, market_data

  // Credentials (encrypted)
  apiKey      String? @map("api_key") @db.Text
  apiSecret   String? @map("api_secret") @db.Text
  credentials Json? // Other credentials

  // Configuration
  baseUrl String @map("base_url")
  config  Json? // Service-specific config

  // Rate Limits
  rateLimit    Int?  @map("rate_limit")
  dailyLimit   Int?  @map("daily_limit")
  currentUsage Json? @map("current_usage")

  // Status
  isActive     Boolean   @default(true) @map("is_active")
  lastTested   DateTime? @map("last_tested")
  healthStatus String    @default("unknown") @map("health_status")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([accountId, name])
  @@index([accountId])
  @@map("ai_external_services")
}

// ============================================
// AI Chat & Memory System (Nova)
// ============================================

// AI Chat Sessions - User conversations with Nova
model AIChatSession {
  id        String  @id @default(uuid())
  userId    String  @map("user_id")
  accountId String? @map("account_id")

  // Session Info
  title       String @default("New Conversation")
  sessionType String @default("general") @map("session_type") // general, support, training, analytics, task

  // Context
  userRole    String @map("user_role") // super_admin, admin, manager, sales
  contextData Json?  @map("context_data") // Any additional context

  // Memory Snapshot
  memorySnapshot Json? @map("memory_snapshot") // Relevant memories at start

  // Status
  status   String  @default("active") // active, archived, deleted
  isPinned Boolean @default(false) @map("is_pinned")

  // Metrics
  messageCount Int @default(0) @map("message_count")

  // Timestamps
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  messages AIChatMessage[]

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_chat_sessions")
}

// AI Chat Messages - Individual messages within sessions
model AIChatMessage {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // Message Content
  role    String // user, assistant, system
  content String @db.Text

  // Attachments
  hasAttachments Boolean @default(false) @map("has_attachments")

  // AI Processing
  tokensUsed   Int?    @map("tokens_used")
  modelUsed    String? @map("model_used")
  processingMs Int?    @map("processing_ms")

  // Memory Operations
  memoriesAccessed String[] @default([]) @map("memories_accessed") // Memory IDs accessed
  memoriesCreated  String[] @default([]) @map("memories_created") // Memory IDs created

  // Context at time of message
  contextUsed Json? @map("context_used")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  session     AIChatSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  attachments AIChatAttachment[]

  @@index([sessionId])
  @@index([role])
  @@index([createdAt])
  @@map("ai_chat_messages")
}

// AI Chat Attachments - Files attached to messages
model AIChatAttachment {
  id        String @id @default(uuid())
  messageId String @map("message_id")

  // File Info
  filename     String
  originalName String @map("original_name")
  mimeType     String @map("mime_type")
  fileSize     Int    @map("file_size") // bytes

  // Storage
  storageUrl   String  @map("storage_url")
  thumbnailUrl String? @map("thumbnail_url")

  // File Type Category
  category String // image, document, data (csv, xml)

  // Processing Status
  isProcessed   Boolean @default(false) @map("is_processed")
  processedData Json?   @map("processed_data") // Extracted text, data, etc

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  message AIChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([category])
  @@map("ai_chat_attachments")
}

// AI User Memory - User-specific persistent memory
model AIUserMemory {
  id        String  @id @default(uuid())
  userId    String  @map("user_id")
  accountId String? @map("account_id")

  // Memory Hierarchy
  scope    String // global, company, role, user
  userRole String? @map("user_role") // Role if scope is 'role'

  // Memory Content
  category String // preference, context, learned, fact, instruction
  key      String
  value    Json
  summary  String? @db.Text // Human-readable summary

  // Importance
  importance Float @default(0.5) // 0-1 priority

  // Usage Tracking
  accessCount  Int       @default(0) @map("access_count")
  lastAccessed DateTime? @map("last_accessed")

  // Lifecycle
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at")

  // Source
  source          String  @default("conversation") // conversation, manual, system, learning
  sourceMessageId String? @map("source_message_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, scope, category, key])
  @@index([userId])
  @@index([accountId])
  @@index([scope])
  @@index([category])
  @@index([userRole])
  @@map("ai_user_memories")
}

// ============================================
// AI Conversation Oversight (Super Admin)
// ============================================

// AI Conversation Checkpoints - Snapshots for reversion
model AIConversationCheckpoint {
  id        String @id @default(uuid())
  sessionId String @map("session_id")
  messageId String @map("message_id") // Message that created this checkpoint

  // Checkpoint Info
  checkpointNumber Int     @map("checkpoint_number")
  name             String? // Optional name for the checkpoint
  description      String? @db.Text

  // Conversation State
  conversationState Json  @map("conversation_state") // Full messages up to this point
  memoryState       Json? @map("memory_state") // Memories at this point

  // File Changes
  fileChanges AIFileChange[]

  // Who created it
  createdBy   String  @map("created_by") // User who created (auto or super admin)
  isAutomatic Boolean @default(true) @map("is_automatic") // Auto-created or manual

  // Status
  isActive   Boolean   @default(true) @map("is_active")
  revertedAt DateTime? @map("reverted_at") // If this was reverted from
  revertedBy String?   @map("reverted_by")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([messageId])
  @@index([checkpointNumber])
  @@map("ai_conversation_checkpoints")
}

// AI File Changes - Track file modifications during conversations
model AIFileChange {
  id           String @id @default(uuid())
  checkpointId String @map("checkpoint_id")
  messageId    String @map("message_id")

  // File Info
  filePath String @map("file_path")
  fileType String @map("file_type") // ts, tsx, json, etc

  // Change Details
  changeType    String  @map("change_type") // create, modify, delete
  beforeContent String? @map("before_content") @db.Text // Content before change
  afterContent  String? @map("after_content") @db.Text // Content after change
  diff          String? @db.Text // Unified diff format

  // Metadata
  linesAdded   Int @default(0) @map("lines_added")
  linesRemoved Int @default(0) @map("lines_removed")

  // Reversion Status
  isReverted Boolean   @default(false) @map("is_reverted")
  revertedAt DateTime? @map("reverted_at")
  revertedBy String?   @map("reverted_by")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  checkpoint AIConversationCheckpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  @@index([checkpointId])
  @@index([messageId])
  @@index([filePath])
  @@map("ai_file_changes")
}

// AI Thought Logs - Stream of AI reasoning (visible to super admin)
model AIThoughtLog {
  id        String  @id @default(uuid())
  sessionId String  @map("session_id")
  messageId String? @map("message_id") // Associated message (null while streaming)

  // Thought Content
  thoughtType String @map("thought_type") // reasoning, tool_call, tool_result, decision, reflection
  content     String @db.Text
  sequence    Int // Order in the thought chain

  // Tool Usage
  toolName   String? @map("tool_name")
  toolInput  Json?   @map("tool_input")
  toolOutput Json?   @map("tool_output")

  // Timing
  durationMs Int? @map("duration_ms")

  // Status
  isVisible Boolean @default(true) @map("is_visible") // Can be hidden by super admin

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([messageId])
  @@index([sequence])
  @@map("ai_thought_logs")
}

// AI Conversation Control - Active conversation states
model AIConversationControl {
  id        String @id @default(uuid())
  sessionId String @unique @map("session_id")

  // Current State
  status           String  @default("idle") // idle, thinking, streaming, stopped, completed
  currentMessageId String? @map("current_message_id")

  // Control
  stopRequested   Boolean   @default(false) @map("stop_requested")
  stopRequestedBy String?   @map("stop_requested_by")
  stopRequestedAt DateTime? @map("stop_requested_at")

  // Super Admin Watching
  watchingUsers String[] @default([]) @map("watching_users") // User IDs watching this conversation

  // Last Activity
  lastActivityAt DateTime @default(now()) @map("last_activity_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([status])
  @@map("ai_conversation_controls")
}

// ============================================
// Error Monitoring & AI Intervention System
// ============================================

// Error Sensitivity Levels
enum ErrorSeverity {
  INFO // Informational logs
  WARNING // Potential issues
  ERROR // Errors requiring attention
  CRITICAL // Critical errors requiring immediate action
  FATAL // System-breaking errors
}

// Error Status
enum ErrorTicketStatus {
  DETECTED // Just detected
  ANALYZING // AI is analyzing
  INTERVENING // AI is intervening with user
  RESOLVED // Resolved by AI or user
  ESCALATED // Escalated to admin
  CLOSED // Manually closed
}

// User Session Error Log - Tracks errors per user session
model UserSessionErrorLog {
  id           String  @id @default(uuid())
  userId       String  @map("user_id")
  accountId    String? @map("account_id")
  sessionToken String  @map("session_token") // Browser session identifier

  // Error Details
  errorType    String  @map("error_type") // api_error, ui_error, validation_error, auth_error, sync_error, network_error
  errorCode    String? @map("error_code")
  errorMessage String  @map("error_message") @db.Text
  stackTrace   String? @map("stack_trace") @db.Text

  // Context
  endpoint        String? // API endpoint that failed
  httpMethod      String? @map("http_method")
  httpStatus      Int?    @map("http_status")
  requestPayload  Json?   @map("request_payload")
  responsePayload Json?   @map("response_payload")

  // User Action Context
  userAction String? @map("user_action") // What user was trying to do
  pageUrl    String? @map("page_url")
  component  String? // UI component that triggered error

  // Severity & Classification
  severity       ErrorSeverity @default(ERROR)
  isRecurring    Boolean       @default(false) @map("is_recurring")
  occurenceCount Int           @default(1) @map("occurence_count")

  // Processing Status
  processed   Boolean   @default(false)
  processedAt DateTime? @map("processed_at")
  ticketId    String?   @map("ticket_id")

  // Timestamps
  firstOccurrence DateTime @default(now()) @map("first_occurrence")
  lastOccurrence  DateTime @default(now()) @map("last_occurrence")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  ticket ErrorTicket? @relation(fields: [ticketId], references: [id])

  @@index([userId])
  @@index([accountId])
  @@index([sessionToken])
  @@index([errorType])
  @@index([severity])
  @@index([processed])
  @@index([createdAt])
  @@map("user_session_error_logs")
}

// Error Ticket - AI Intervention tracking
model ErrorTicket {
  id        String  @id @default(uuid())
  userId    String  @map("user_id")
  accountId String? @map("account_id")

  // Ticket Info
  ticketNumber String @unique @map("ticket_number") // ERR-XXXX format
  title        String
  description  String @db.Text

  // Classification
  severity ErrorSeverity     @default(ERROR)
  status   ErrorTicketStatus @default(DETECTED)
  priority Int               @default(3) // 1=highest, 5=lowest

  // Error Pattern
  errorPattern    String  @map("error_pattern") // Grouped error pattern identifier
  errorCount      Int     @default(1) @map("error_count")
  affectedFeature String? @map("affected_feature")

  // AI Analysis
  aiAnalysis   String? @map("ai_analysis") @db.Text
  aiDiagnosis  String? @map("ai_diagnosis") @db.Text
  aiSolution   String? @map("ai_solution") @db.Text
  aiConfidence Float?  @map("ai_confidence") // 0-1 confidence score

  // Timing
  detectedAt  DateTime  @default(now()) @map("detected_at")
  analyzedAt  DateTime? @map("analyzed_at")
  interveneAt DateTime? @map("intervene_at")
  resolvedAt  DateTime? @map("resolved_at")

  // Detection to Intervention timing
  detectionToAnalysisMs    Int? @map("detection_to_analysis_ms")
  analysisToInterventionMs Int? @map("analysis_to_intervention_ms")
  totalResolutionMs        Int? @map("total_resolution_ms")

  // Resolution
  resolutionMethod String? @map("resolution_method") // ai_auto, user_action, admin_manual, escalation
  resolutionNotes  String? @map("resolution_notes") @db.Text

  // Escalation
  escalatedTo      String?   @map("escalated_to") // admin user id
  escalatedAt      DateTime? @map("escalated_at")
  escalationReason String?   @map("escalation_reason")

  // Color Alert
  alertColor String @default("yellow") @map("alert_color") // green, yellow, orange, red, purple

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  errorLogs     UserSessionErrorLog[]
  interventions AIIntervention[]

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([severity])
  @@index([alertColor])
  @@index([createdAt])
  @@map("error_tickets")
}

// AI Intervention - Records of AI helping users
model AIIntervention {
  id       String @id @default(uuid())
  ticketId String @map("ticket_id")
  userId   String @map("user_id")

  // Intervention Type
  interventionType String @map("intervention_type") // proactive_message, guided_help, auto_fix, escalation_notice

  // Message Sent to User
  messageToUser    String    @map("message_to_user") @db.Text
  messageDelivered Boolean   @default(false) @map("message_delivered")
  messageReadAt    DateTime? @map("message_read_at")

  // User Response
  userResponse    String?   @map("user_response") @db.Text
  userRespondedAt DateTime? @map("user_responded_at")

  // AI Agent Info
  aiAgentRole String  @map("ai_agent_role") // support_ai, admin_ai, root_ai
  aiSessionId String? @map("ai_session_id")

  // Steps Provided
  stepsProvided  Json? @map("steps_provided") // Array of step-by-step guidance
  stepsCompleted Int   @default(0) @map("steps_completed")

  // Outcome
  wasHelpful   Boolean? @map("was_helpful")
  userFeedback String?  @map("user_feedback")
  resolved     Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ticket ErrorTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@index([interventionType])
  @@index([resolved])
  @@map("ai_interventions")
}

// Error Monitoring Config - Per-account settings
model ErrorMonitoringConfig {
  id        String  @id @default(uuid())
  accountId String? @unique @map("account_id") // null = global defaults

  // Scanning Settings
  scanIntervalSeconds Int     @default(180) @map("scan_interval_seconds") // 3 minutes default
  isEnabled           Boolean @default(true) @map("is_enabled")

  // Sensitivity Thresholds
  minSeverityForAlert ErrorSeverity @default(ERROR) @map("min_severity_for_alert")
  errorCountThreshold Int           @default(3) @map("error_count_threshold") // Errors before AI intervenes

  // Time Windows
  errorWindowMinutes          Int @default(5) @map("error_window_minutes") // Time window for counting errors
  maxInterventionDelaySeconds Int @default(300) @map("max_intervention_delay_seconds") // Max 5 min before AI must intervene

  // Alert Colors Configuration
  greenThreshold  Int @default(0) @map("green_threshold") // 0 errors
  yellowThreshold Int @default(2) @map("yellow_threshold") // 1-2 errors
  orangeThreshold Int @default(5) @map("orange_threshold") // 3-5 errors
  redThreshold    Int @default(10) @map("red_threshold") // 6-10 errors
  // Purple = > redThreshold (critical)

  // AI Intervention Settings
  autoIntervene   Boolean @default(true) @map("auto_intervene")
  autoEscalate    Boolean @default(true) @map("auto_escalate")
  escalationDelay Int     @default(900) @map("escalation_delay") // 15 min before escalation

  // Notification Channels
  notifyEmail  Boolean @default(true) @map("notify_email")
  notifyInApp  Boolean @default(true) @map("notify_in_app")
  notifySlack  Boolean @default(false) @map("notify_slack")
  slackWebhook String? @map("slack_webhook")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("error_monitoring_configs")
}

// Error Pattern - Learned error patterns for better detection
model ErrorPattern {
  id String @id @default(uuid())

  // Pattern Identification
  patternHash String @unique @map("pattern_hash") // Hash of error signature
  patternName String @map("pattern_name")

  // Pattern Details
  errorType        String  @map("error_type")
  errorCodePattern String? @map("error_code_pattern") // Regex or exact match
  messagePattern   String  @map("message_pattern") @db.Text // Regex for matching
  endpointPattern  String? @map("endpoint_pattern")

  // Classification
  severity ErrorSeverity @default(ERROR)
  category String // authentication, data_sync, api_limit, validation, network, unknown

  // AI Knowledge
  rootCause      String? @map("root_cause") @db.Text
  solution       String? @map("solution") @db.Text
  preventionTips String? @map("prevention_tips") @db.Text

  // Statistics
  totalOccurrences Int  @default(0) @map("total_occurrences")
  resolvedCount    Int  @default(0) @map("resolved_count")
  avgResolutionMs  Int? @map("avg_resolution_ms")

  // Learning
  isVerified  Boolean  @default(false) @map("is_verified") // Manually verified by admin
  lastUpdated DateTime @default(now()) @map("last_updated")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([patternHash])
  @@index([errorType])
  @@index([category])
  @@map("error_patterns")
}

// AI Intervention Summary - Root AI summarized reports
model AIInterventionSummary {
  id String @id @default(uuid())

  // Summary Scope
  summaryType String   @map("summary_type") // daily, weekly, monthly, incident
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  accountId   String?  @map("account_id") // null = system-wide

  // Counts
  totalErrors        Int @map("total_errors")
  totalTickets       Int @map("total_tickets")
  totalInterventions Int @map("total_interventions")
  resolvedCount      Int @map("resolved_count")
  escalatedCount     Int @map("escalated_count")

  // Severity Breakdown
  criticalCount Int @default(0) @map("critical_count")
  errorCount    Int @default(0) @map("error_count")
  warningCount  Int @default(0) @map("warning_count")
  infoCount     Int @default(0) @map("info_count")

  // AI Agent Summary (by agent role)
  agentSummary String @map("agent_summary") @db.Text // AI agent's summary

  // Root AI Re-Summary
  rootAISummary String? @map("root_ai_summary") @db.Text // Root AI consolidated summary

  // Diagnostics
  topErrorPatterns Json? @map("top_error_patterns") // Most common patterns
  recommendations  Json? // AI recommendations for improvement

  // Performance Metrics
  avgDetectionTime  Int?   @map("avg_detection_time") // ms
  avgResolutionTime Int?   @map("avg_resolution_time") // ms
  successRate       Float? @map("success_rate") // % of successful AI interventions

  // Timestamps
  generatedAt DateTime @default(now()) @map("generated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([summaryType])
  @@index([periodStart, periodEnd])
  @@index([accountId])
  @@map("ai_intervention_summaries")
}

// ============================================
// IAI Soldier Command Center
// ============================================

model IAISoldier {
  id            String  @id @default(uuid())
  soldierNumber Int     @default(autoincrement()) @map("soldier_number")
  soldierId     String  @unique @map("soldier_id") // IAI-0, IAI-1, etc.
  accountId     String  @map("account_id")
  userId        String? @map("user_id")

  // Status
  status   String  @default("offline") // online, offline, working, idle, error
  isActive Boolean @default(true) @map("is_active")

  // Identity
  browserId        String? @map("browser_id")
  extensionVersion String? @map("extension_version")
  userAgent        String? @map("user_agent")

  // Location & Network
  ipAddress       String?  @map("ip_address")
  locationCountry String?  @map("location_country")
  locationCity    String?  @map("location_city")
  locationLat     Decimal? @map("location_lat") @db.Decimal(10, 8)
  locationLng     Decimal? @map("location_lng") @db.Decimal(11, 8)
  timezone        String?

  // Performance Stats
  tasksCompleted      Int      @default(0) @map("tasks_completed")
  tasksFailed         Int      @default(0) @map("tasks_failed")
  totalRuntimeMinutes Int      @default(0) @map("total_runtime_minutes")
  avgTaskDurationSec  Int?     @map("avg_task_duration_sec")
  successRate         Decimal? @map("success_rate") @db.Decimal(5, 2)

  // Current Work
  currentTaskId        String?   @map("current_task_id")
  currentTaskType      String?   @map("current_task_type")
  currentTaskStartedAt DateTime? @map("current_task_started_at")

  // Heartbeat
  lastHeartbeatAt DateTime? @map("last_heartbeat_at")
  lastPollAt      DateTime? @map("last_poll_at")
  lastTaskAt      DateTime? @map("last_task_at")
  lastError       String?
  lastErrorAt     DateTime? @map("last_error_at")

  // Session
  sessionStartAt DateTime? @map("session_start_at")
  sessionEndAt   DateTime? @map("session_end_at")
  totalSessions  Int       @default(0) @map("total_sessions")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account              Account                  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user                 User?                    @relation(fields: [userId], references: [id], onDelete: SetNull)
  activityLogs         IAIActivityLog[]
  performanceSnapshots IAIPerformanceSnapshot[]

  @@index([accountId])
  @@index([status])
  @@index([soldierId])
  @@index([lastHeartbeatAt])
  @@map("iai_soldiers")
}

model IAIActivityLog {
  id        String @id @default(uuid())
  soldierId String @map("soldier_id")
  accountId String @map("account_id")

  // Event Details
  eventType String  @map("event_type") // heartbeat, task_start, task_complete, task_fail, status_change, error
  eventData Json?   @map("event_data")
  message   String?

  // Task Reference
  taskId     String? @map("task_id")
  taskType   String? @map("task_type")
  taskResult Json?   @map("task_result")

  // Location at time of event
  ipAddress   String?  @map("ip_address")
  locationLat Decimal? @map("location_lat") @db.Decimal(10, 8)
  locationLng Decimal? @map("location_lng") @db.Decimal(11, 8)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  soldier IAISoldier @relation(fields: [soldierId], references: [id], onDelete: Cascade)
  account Account    @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([soldierId])
  @@index([accountId])
  @@index([eventType])
  @@index([createdAt])
  @@map("iai_activity_logs")
}

model IAIPerformanceSnapshot {
  id        String @id @default(uuid())
  soldierId String @map("soldier_id")

  // Snapshot Time
  snapshotAt DateTime @default(now()) @map("snapshot_at")

  // Metrics
  tasksInPeriod  Int      @default(0) @map("tasks_in_period")
  successCount   Int      @default(0) @map("success_count")
  failureCount   Int      @default(0) @map("failure_count")
  avgDurationSec Int?     @map("avg_duration_sec")
  cpuUsage       Decimal? @map("cpu_usage") @db.Decimal(5, 2)
  memoryUsageMb  Int?     @map("memory_usage_mb")

  // Status
  status      String @map("status")
  errorsCount Int    @default(0) @map("errors_count")

  // Relations
  soldier IAISoldier @relation(fields: [soldierId], references: [id], onDelete: Cascade)

  @@index([soldierId])
  @@index([snapshotAt])
  @@map("iai_performance_snapshots")
}

// ============================================
// IAI Training System
// ============================================

model TrainingSession {
  id        String @id @default(uuid())
  sessionId String @unique @map("session_id") // Client-generated session ID

  // Recording Configuration
  mode          String @default("listing") @map("mode") // listing, messages, navigation, full
  recordingType String @default("iai") @map("recording_type") // iai, soldier

  // Session Data
  duration            Int   @default(0) @map("duration") // Duration in ms
  totalEvents         Int   @default(0) @map("total_events")
  markedElementsCount Int   @default(0) @map("marked_elements_count")
  metadata            Json? @map("metadata")

  // Processed Data
  clickSequence  Json? @map("click_sequence") // Array of click events in order
  typingPatterns Json? @map("typing_patterns") // Typing patterns detected
  automationCode Json? @map("automation_code") // Generated automation code

  // Status
  status      String    @default("RECORDED") @map("status") // RECORDED, PROCESSED, ACTIVE, ARCHIVED
  isActive    Boolean   @default(false) @map("is_active")
  processedAt DateTime? @map("processed_at")

  // Relations
  createdById String? @map("created_by_id")
  createdBy   User?   @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Child Relations
  events         TrainingEvent[]
  markedElements TrainingMarkedElement[]
  fieldMappings  TrainingFieldMapping[]
  patterns       TrainingPattern[]

  @@index([mode])
  @@index([recordingType])
  @@index([status])
  @@index([isActive])
  @@index([createdAt])
  @@map("training_sessions")
}

model TrainingEvent {
  id        String @id @default(uuid())
  sessionId String @map("session_id")
  eventId   String @map("event_id") // Client-generated event ID

  // Event Details
  type         String   @map("type") // click, input, scroll, focus, mutation, keydown
  timestamp    DateTime @map("timestamp")
  relativeTime Int      @default(0) @map("relative_time") // ms from session start
  url          String?  @map("url")

  // Element Information
  fieldType   String? @map("field_type") // vehicleType, year, make, model, etc.
  isMarked    Boolean @default(false) @map("is_marked")
  elementData Json?   @map("element_data") // Full element info

  // Position & Modifiers
  mousePosition Json? @map("mouse_position") // x, y coordinates
  modifiers     Json? @map("modifiers") // ctrl, shift, alt, meta

  // Additional Data
  additionalData Json? @map("additional_data")

  // Relations
  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type])
  @@index([timestamp])
  @@index([fieldType])
  @@index([isMarked])
  @@map("training_events")
}

model TrainingMarkedElement {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // Field Information
  fieldType String @map("field_type") // vehicleType, year, make, model, etc.
  order     Int    @default(0) @map("order") // Order in the sequence

  // Element Data
  elementData Json     @map("element_data") // Full element info
  selectors   String[] @default([]) @map("selectors") // CSS selectors
  ariaLabel   String?  @map("aria_label")
  role        String?  @map("role")

  // Type Flags
  isDropdown Boolean @default(false) @map("is_dropdown")
  isInput    Boolean @default(false) @map("is_input")
  isButton   Boolean @default(false) @map("is_button")

  // Timing
  timestamp    DateTime @map("timestamp")
  relativeTime Int      @default(0) @map("relative_time")

  // Relations
  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([fieldType])
  @@index([order])
  @@map("training_marked_elements")
}

model TrainingFieldMapping {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // Field Definition
  fieldType         String   @map("field_type") // vehicleType, year, make, model, etc.
  primarySelector   String   @map("primary_selector")
  fallbackSelectors String[] @default([]) @map("fallback_selectors")

  // Element Hints
  ariaLabel     String?  @map("aria_label")
  role          String?  @map("role")
  placeholder   String?  @map("placeholder")
  parentContext String[] @default([]) @map("parent_context") // Parent selectors for context

  // Type Flags
  isDropdown Boolean @default(false) @map("is_dropdown")
  isInput    Boolean @default(false) @map("is_input")

  // Relations
  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, fieldType])
  @@index([sessionId])
  @@index([fieldType])
  @@map("training_field_mappings")
}

model TrainingPattern {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // Pattern Information
  patternType    String   @map("pattern_type") // dropdowns, inputs, buttons, navigation, fileUploads, timing
  fieldType      String?  @map("field_type")
  selectors      String[] @default([]) @map("selectors")
  ariaLabel      String?  @map("aria_label")
  text           String?  @map("text")
  timestamp      Int?     @map("timestamp")
  additionalData Json?    @map("additional_data")

  // Relations
  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([patternType])
  @@map("training_patterns")
}

// ============================================
// IntelliCeil Session & Visitor Analytics
// ============================================

// User Session - Authenticated user sessions
model UserSession {
  id           String @id @default(uuid())
  userId       String @map("user_id")
  sessionToken String @unique @map("session_token")

  // Session Info
  ipAddress  String  @map("ip_address")
  userAgent  String  @map("user_agent")
  deviceType String? @map("device_type") // desktop, mobile, tablet
  browser    String?
  os         String?

  // Timing
  loginAt      DateTime  @default(now()) @map("login_at")
  lastActiveAt DateTime  @default(now()) @map("last_active_at")
  logoutAt     DateTime? @map("logout_at")
  duration     Int?      @map("duration") // seconds

  // Status
  isActive    Boolean @default(true) @map("is_active")
  loginMethod String? @map("login_method") // email, google, facebook

  // Security
  ipInfo      Json?  @map("ip_info") // Full IP analysis data
  botScore    Int    @default(0) @map("bot_score") // 0-100
  threatLevel String @default("NORMAL") @map("threat_level")

  // Geolocation
  country     String?
  countryCode String? @map("country_code")
  city        String?
  latitude    Float?
  longitude   Float?
  timezone    String?

  // Relations
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities SessionActivity[]

  @@index([userId])
  @@index([sessionToken])
  @@index([ipAddress])
  @@index([loginAt])
  @@index([isActive])
  @@map("user_sessions")
}

// Session Activity - Actions within a session
model SessionActivity {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // Activity Info
  action     String // page_view, api_call, login, logout, etc.
  path       String? // URL path
  method     String? // HTTP method
  statusCode Int?    @map("status_code")
  responseMs Int?    @map("response_ms")

  // Details
  details   Json?
  timestamp DateTime @default(now())

  // Relations
  session UserSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@index([action])
  @@map("session_activities")
}

// Visitor - Anonymous/unauthenticated visitors
model Visitor {
  id          String @id @default(uuid())
  fingerprint String @unique // Browser fingerprint

  // Visit Frequency & Heat
  visitCount   Int      @default(1) @map("visit_count")
  heatScore    Int      @default(0) @map("heat_score") // 0-100, frequency indicator
  firstVisitAt DateTime @default(now()) @map("first_visit_at")
  lastVisitAt  DateTime @default(now()) @map("last_visit_at")

  // Visit Classification
  visitorType    String  @default("first_time") @map("visitor_type") // first_time, returning, frequent, loyal
  potentialUser  Boolean @default(false) @map("potential_user")
  potentialScore Int     @default(0) @map("potential_score") // 0-100

  // Conversion
  convertedAt     DateTime? @map("converted_at")
  convertedUserId String?   @map("converted_user_id")

  // Last Known Info
  lastIpAddress String? @map("last_ip_address")
  lastUserAgent String? @map("last_user_agent")
  lastCountry   String? @map("last_country")
  lastCity      String? @map("last_city")

  // Bot Detection
  isBotConfirmed Boolean  @default(false) @map("is_bot_confirmed")
  botScore       Int      @default(0) @map("bot_score")
  botIndicators  String[] @default([]) @map("bot_indicators")
  botName        String?  @map("bot_name") // Googlebot, Bingbot, etc.

  // Relations
  visits VisitorSession[]

  @@index([fingerprint])
  @@index([heatScore])
  @@index([visitorType])
  @@index([isBotConfirmed])
  @@map("visitors")
}

// Visitor Session - Individual visit sessions for anonymous users
model VisitorSession {
  id        String @id @default(uuid())
  visitorId String @map("visitor_id")

  // Session Info
  sessionToken String @unique @map("session_token")
  ipAddress    String @map("ip_address")
  userAgent    String @map("user_agent")

  // Timing
  startedAt DateTime  @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  duration  Int?
  pageViews Int       @default(0) @map("page_views")

  // Journey
  entryPage String? @map("entry_page")
  exitPage  String? @map("exit_page")
  referrer  String?

  // Device
  deviceType String? @map("device_type")
  browser    String?
  os         String?

  // Geolocation
  country     String?
  countryCode String? @map("country_code")
  city        String?
  latitude    Float?
  longitude   Float?

  // IP Analysis
  ipInfo   Json? @map("ip_info")
  botScore Int   @default(0) @map("bot_score")

  // Relations
  visitor    Visitor           @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  pageViewed VisitorPageView[]

  @@index([visitorId])
  @@index([sessionToken])
  @@index([ipAddress])
  @@index([startedAt])
  @@map("visitor_sessions")
}

// Visitor Page Views
model VisitorPageView {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  path        String
  title       String?
  duration    Int? // seconds on page
  scrollDepth Int?     @map("scroll_depth") // percentage
  timestamp   DateTime @default(now())

  // Relations
  session VisitorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([path])
  @@map("visitor_page_views")
}

// IP Intelligence - Detailed IP analysis cache
model IPIntelligence {
  id        String @id @default(uuid())
  ipAddress String @unique @map("ip_address")

  // Geolocation
  country     String?
  countryCode String? @map("country_code")
  region      String?
  city        String?
  latitude    Float?
  longitude   Float?
  timezone    String?
  isp         String?
  org         String?
  asn         String?

  // Threat Assessment
  threatScore   Int     @default(0) @map("threat_score") // 0-100
  threatLevel   String  @default("NORMAL") @map("threat_level") // NORMAL, LOW, MEDIUM, HIGH, CRITICAL
  isProxy       Boolean @default(false) @map("is_proxy")
  isVpn         Boolean @default(false) @map("is_vpn")
  isTor         Boolean @default(false) @map("is_tor")
  isDatacenter  Boolean @default(false) @map("is_datacenter")
  isKnownAbuser Boolean @default(false) @map("is_known_abuser")

  // Bot Detection
  isBotConfirmed Boolean  @default(false) @map("is_bot_confirmed")
  botScore       Int      @default(0) @map("bot_score")
  botName        String?  @map("bot_name")
  botType        String?  @map("bot_type") // search_engine, scraper, monitoring, malicious
  botIdentifiers String[] @default([]) @map("bot_identifiers")

  // Request Statistics
  totalRequests Int      @default(0) @map("total_requests")
  requestsToday Int      @default(0) @map("requests_today")
  lastRequestAt DateTime @default(now()) @map("last_request_at")
  firstSeenAt   DateTime @default(now()) @map("first_seen_at")

  // Block Status
  isBlocked     Boolean   @default(false) @map("is_blocked")
  blockedAt     DateTime? @map("blocked_at")
  blockedReason String?   @map("blocked_reason")
  autoBlocked   Boolean   @default(false) @map("auto_blocked")

  // Cache
  lastUpdated DateTime @default(now()) @map("last_updated")
  rawData     Json?    @map("raw_data")

  @@index([ipAddress])
  @@index([threatScore])
  @@index([isBotConfirmed])
  @@index([isBlocked])
  @@map("ip_intelligence")
}

// Known Bots Registry
model KnownBot {
  id   String @id @default(uuid())
  name String @unique
  type String // search_engine, scraper, monitoring, security, malicious

  // Identification
  userAgentPattern String?  @map("user_agent_pattern")
  ipRanges         String[] @default([]) @map("ip_ranges")

  // Classification
  isGood      Boolean @default(false) @map("is_good") // Googlebot = good, Scraper = bad
  description String?
  website     String?

  // Stats
  lastSeenAt    DateTime? @map("last_seen_at")
  totalRequests Int       @default(0) @map("total_requests")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@index([type])
  @@map("known_bots")
}

// Admin Login Audit
model AdminLoginAudit {
  id     String @id @default(uuid())
  userId String @map("user_id")
  email  String
  role   String

  // Login Details
  ipAddress   String @map("ip_address")
  userAgent   String @map("user_agent")
  loginMethod String @map("login_method")

  // Status
  success       Boolean @default(true)
  failureReason String? @map("failure_reason")

  // Geolocation
  country String?
  city    String?

  // Security
  suspicious        Boolean  @default(false)
  suspiciousReasons String[] @default([]) @map("suspicious_reasons")

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([timestamp])
  @@index([ipAddress])
  @@map("admin_login_audit")
}

// ============================================
// Facebook Session-Based Authentication
// (Replaces OAuth - for Marketplace posting)
// ============================================

// Session Status Enum
enum FbSessionStatus {
  ACTIVE // Session is valid and working
  EXPIRED // Session has expired
  INVALID // Session was invalidated by Facebook
  SYNCING // Session is being synced
  RECOVERING // Session recovery in progress via 2FA
}

// Session Source Enum
enum FbSessionSource {
  EXTENSION // Captured from desktop Chrome extension
  SERVER // Created by Nova worker on server
  MANUAL // Manually imported
  RECOVERED // Recovered via 2FA auto-login
}

// Session Sync Direction
enum FbSyncDirection {
  EXTENSION_TO_SERVER
  SERVER_TO_EXTENSION
}

// Session Sync Status
enum FbSyncStatus {
  SUCCESS
  FAILED
  PARTIAL
}

// Main Facebook Session Table
model FbSession {
  id        String @id @default(cuid())
  accountId String @map("account_id")

  // Facebook Identity
  fbUserId     String? @map("fb_user_id") // From c_user cookie
  fbUserName   String? @map("fb_user_name") // Display name
  fbProfilePic String? @map("fb_profile_pic")

  // Encrypted Session Data (AES-256-GCM)
  encryptedCookies      String  @map("encrypted_cookies") @db.Text
  encryptedLocalStorage String? @map("encrypted_local_storage") @db.Text
  encryptionSalt        String  @map("encryption_salt")
  encryptionIv          String  @map("encryption_iv")

  // Session Metadata
  sessionStatus      FbSessionStatus @default(ACTIVE) @map("session_status")
  source             FbSessionSource @default(EXTENSION)
  userAgent          String?         @map("user_agent")
  ipAddress          String?         @map("ip_address")
  browserFingerprint String?         @map("browser_fingerprint")

  // Validity Tracking
  capturedAt      DateTime  @default(now()) @map("captured_at")
  expiresAt       DateTime? @map("expires_at")
  lastValidatedAt DateTime? @map("last_validated_at")
  lastUsedAt      DateTime? @map("last_used_at")
  lastSyncedAt    DateTime? @map("last_synced_at")

  // Health Metrics
  validationCount   Int @default(0) @map("validation_count")
  failedValidations Int @default(0) @map("failed_validations")
  successfulTasks   Int @default(0) @map("successful_tasks")
  failedTasks       Int @default(0) @map("failed_tasks")

  // 2FA Association
  totpSecretId String? @map("totp_secret_id")
  has2FA       Boolean @default(false) @map("has_2fa")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account    Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  totpSecret FbTotpSecret?      @relation(fields: [totpSecretId], references: [id])
  syncLogs   FbSessionSyncLog[]

  @@unique([accountId, fbUserId])
  @@index([accountId])
  @@index([sessionStatus])
  @@index([lastValidatedAt])
  @@index([expiresAt])
  @@map("fb_sessions")
}

// 2FA TOTP Secrets for Auto-Recovery
model FbTotpSecret {
  id        String @id @default(cuid())
  accountId String @unique @map("account_id")

  // Facebook Identity
  fbUserId String @map("fb_user_id")

  // Encrypted TOTP Secret (AES-256-GCM)
  encryptedSecret String @map("encrypted_secret") @db.Text
  encryptionSalt  String @map("encryption_salt")
  encryptionIv    String @map("encryption_iv")

  // Verification Status
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")

  // Usage Tracking
  lastUsedAt     DateTime? @map("last_used_at")
  useCount       Int       @default(0) @map("use_count")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lastFailedAt   DateTime? @map("last_failed_at")

  // Security
  isLocked    Boolean   @default(false) @map("is_locked")
  lockedUntil DateTime? @map("locked_until")
  lockReason  String?   @map("lock_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account      Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sessions     FbSession[]
  recoveryLogs FbRecoveryLog[]

  @@index([fbUserId])
  @@map("fb_totp_secrets")
}

// Session Sync Log - Track syncs between desktop and server
model FbSessionSyncLog {
  id        String @id @default(cuid())
  sessionId String @map("session_id")

  // Sync Details
  direction FbSyncDirection
  status    FbSyncStatus

  // Source/Target
  sourceDevice String? @map("source_device") // Browser ID or worker ID
  targetDevice String? @map("target_device")

  // Result
  errorMessage String? @map("error_message")
  cookiesCount Int?    @map("cookies_count")

  syncedAt DateTime @default(now()) @map("synced_at")

  // Relations
  session FbSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([syncedAt])
  @@map("fb_session_sync_logs")
}

// 2FA Recovery Log - Track auto-login attempts
model FbRecoveryLog {
  id           String @id @default(cuid())
  totpSecretId String @map("totp_secret_id")

  // Attempt Details
  success      Boolean
  errorMessage String? @map("error_message")

  // Source
  triggeredBy String  @map("triggered_by") // 'nova_worker', 'scheduled', 'manual'
  workerId    String? @map("worker_id")

  // New Session
  newSessionId String? @map("new_session_id")

  attemptedAt DateTime  @default(now()) @map("attempted_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  totpSecret FbTotpSecret @relation(fields: [totpSecretId], references: [id], onDelete: Cascade)

  @@index([totpSecretId])
  @@index([attemptedAt])
  @@map("fb_recovery_logs")
}

// ============================================
// Task Scheduling System
// (For automated IAI task execution)
// ============================================

// Schedule Status
enum ScheduleStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Scheduled Task - Cron-based automation
model ScheduledTask {
  id        String @id @default(cuid())
  accountId String @map("account_id")

  // Task Definition
  taskType     String @map("task_type") // POST_VEHICLE, REFRESH_LISTING, etc.
  taskData     Json   @map("task_data")
  taskPriority Int    @default(5) @map("task_priority") // 1-10

  // Schedule
  cronExpression  String?   @map("cron_expression") // "0 9 * * *" = 9 AM daily
  intervalMinutes Int?      @map("interval_minutes") // Alternative to cron
  nextRunAt       DateTime  @map("next_run_at")
  lastRunAt       DateTime? @map("last_run_at")

  // Execution Preferences
  preferredInstance String? @map("preferred_instance") // 'desktop', 'server', null=any
  maxRetries        Int     @default(3) @map("max_retries")
  retryDelayMin     Int     @default(5) @map("retry_delay_min")

  // Status
  status       ScheduleStatus @default(ACTIVE)
  runCount     Int            @default(0) @map("run_count")
  successCount Int            @default(0) @map("success_count")
  failureCount Int            @default(0) @map("failure_count")

  // Metadata
  name        String?
  description String?
  tags        String[] @default([])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account    Account                  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  executions ScheduledTaskExecution[]

  @@index([accountId])
  @@index([nextRunAt, status])
  @@index([status])
  @@map("scheduled_tasks")
}

// Scheduled Task Execution Log
model ScheduledTaskExecution {
  id              String @id @default(cuid())
  scheduledTaskId String @map("scheduled_task_id")

  // Execution Details
  instanceType String  @map("instance_type") // 'desktop' or 'server'
  instanceId   String? @map("instance_id")

  // Status
  status      String // PENDING, RUNNING, SUCCESS, FAILED, CANCELLED
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  durationMs  Int?      @map("duration_ms")

  // Result
  resultData   Json?   @map("result_data")
  errorMessage String? @map("error_message")
  retryAttempt Int     @default(0) @map("retry_attempt")

  // Relations
  scheduledTask ScheduledTask @relation(fields: [scheduledTaskId], references: [id], onDelete: Cascade)

  @@index([scheduledTaskId])
  @@index([startedAt])
  @@index([status])
  @@map("scheduled_task_executions")
}

// ============================================
// IAI Instance Coordination
// (Prevent duplicate task execution)
// ============================================

// Active IAI Instances (Desktop & Server)
model IAIInstance {
  id         String  @id @default(cuid())
  instanceId String  @unique @map("instance_id") // Unique ID per browser/worker
  accountId  String  @map("account_id")
  userId     String? @map("user_id")

  // Instance Type
  instanceType String @map("instance_type") // 'desktop' or 'server'

  // Identity
  browserId        String? @map("browser_id")
  workerId         String? @map("worker_id")
  extensionVersion String? @map("extension_version")
  userAgent        String? @map("user_agent")

  // Capabilities
  capabilities String[] @default([]) // List of supported task types

  // Status
  status        String  @default("online") // online, offline, working, idle, error
  currentTaskId String? @map("current_task_id")

  // Heartbeat
  lastHeartbeat DateTime  @default(now()) @map("last_heartbeat")
  lastTaskAt    DateTime? @map("last_task_at")

  // Performance
  tasksCompleted  Int  @default(0) @map("tasks_completed")
  tasksFailed     Int  @default(0) @map("tasks_failed")
  avgTaskDuration Int? @map("avg_task_duration") // ms

  // Session Reference
  fbSessionId   String? @map("fb_session_id")
  sessionStatus String? @map("session_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([accountId])
  @@index([instanceType])
  @@index([status])
  @@index([lastHeartbeat])
  @@map("iai_instances")
}

// Task Lock - Prevent duplicate execution
model TaskLock {
  id         String @id @default(cuid())
  taskId     String @unique @map("task_id")
  instanceId String @map("instance_id")

  // Lock Details
  lockedAt  DateTime @default(now()) @map("locked_at")
  expiresAt DateTime @map("expires_at")

  // Task Info
  taskType  String? @map("task_type")
  accountId String? @map("account_id")

  @@index([taskId])
  @@index([expiresAt])
  @@map("task_locks")
}

// ============================================
// AI MODEL ORCHESTRATION
// ============================================

// AI Session Notes - Internal context for seamless agent handoffs
// Auto-destroyed after 1 week
model AISessionNote {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  accountId String   @map("account_id")
  userId    String   @map("user_id")
  agentId   String   @map("agent_id")
  modelId   String   @map("model_id")
  noteType  String   @map("note_type") // context, handoff, summary, preference, error
  content   String   @db.Text
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at") // Auto-cleanup after 1 week

  @@index([sessionId])
  @@index([accountId])
  @@index([expiresAt])
  @@map("ai_session_notes")
}

// AI Task Assignments - Hierarchical model assignments
model AITaskAssignment {
  id              String    @id @default(uuid())
  taskType        String    @map("task_type") // screenshot_analysis, customer_service, etc
  primaryModel    String    @map("primary_model")
  fallbackModel   String    @map("fallback_model")
  allowedModels   String[]  @map("allowed_models")
  assignedBy      String    @map("assigned_by") // system, super_admin, admin, etc
  assignmentLevel String    @map("assignment_level") // global, company, team, user
  priority        Int       @default(50)
  conditions      Json      @default("{}")
  accountId       String?   @map("account_id") // null for global
  teamId          String?   @map("team_id")
  userId          String?   @map("user_id")
  createdById     String    @map("created_by_id")
  expiresAt       DateTime? @map("expires_at")
  enabled         Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([taskType, assignmentLevel, accountId, teamId, userId])
  @@index([taskType])
  @@index([assignmentLevel])
  @@index([accountId])
  @@map("ai_task_assignments")
}

// AI Model Usage Analytics
model AIModelUsage {
  id           String   @id @default(uuid())
  modelId      String   @map("model_id")
  agentId      String   @map("agent_id")
  accountId    String?  @map("account_id")
  userId       String?  @map("user_id")
  sessionId    String?  @map("session_id")
  taskType     String?  @map("task_type")
  inputTokens  Int      @default(0) @map("input_tokens")
  outputTokens Int      @default(0) @map("output_tokens")
  latencyMs    Int      @default(0) @map("latency_ms")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  routingRule  String?  @map("routing_rule") // Which rule routed this request
  wasHandoff   Boolean  @default(false) @map("was_handoff")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([modelId])
  @@index([agentId])
  @@index([accountId])
  @@index([createdAt])
  @@map("ai_model_usage")
}

// AI Routing Rules - Admin-configurable routing
model AIRoutingRule {
  id            String   @id @default(uuid())
  name          String
  description   String?
  priority      Int      @default(50)
  conditions    Json     @default("[]") // Array of routing conditions
  targetModel   String   @map("target_model")
  fallbackModel String   @map("fallback_model")
  accountId     String?  @map("account_id") // null for global
  enabled       Boolean  @default(true)
  createdById   String   @map("created_by_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([priority])
  @@index([accountId])
  @@index([enabled])
  @@map("ai_routing_rules")
}

// AI Agent Handoff Log
model AIHandoffLog {
  id             String   @id @default(uuid())
  sessionId      String   @map("session_id")
  accountId      String?  @map("account_id")
  userId         String?  @map("user_id")
  fromAgent      String   @map("from_agent")
  fromModel      String   @map("from_model")
  toAgent        String   @map("to_agent")
  toModel        String   @map("to_model")
  reason         String
  contextSummary String?  @map("context_summary") @db.Text
  seamless       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([accountId])
  @@index([createdAt])
  @@map("ai_handoff_logs")
}

// Company AI Preferences - Super admin configurable
model CompanyAIPreferences {
  id                  String   @id @default(uuid())
  accountId           String   @unique @map("account_id")
  defaultModel        String?  @map("default_model")
  allowedModels       String[] @map("allowed_models")
  blockedModels       String[] @map("blocked_models")
  maxTokensPerRequest Int?     @map("max_tokens_per_request")
  maxRequestsPerDay   Int?     @map("max_requests_per_day")
  costBudgetDaily     Decimal? @map("cost_budget_daily") @db.Decimal(10, 2)
  costBudgetMonthly   Decimal? @map("cost_budget_monthly") @db.Decimal(10, 2)
  enableVision        Boolean  @default(true) @map("enable_vision")
  enableCodeGen       Boolean  @default(true) @map("enable_code_gen")
  enableAutomation    Boolean  @default(true) @map("enable_automation")
  customInstructions  String?  @map("custom_instructions") @db.Text
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("company_ai_preferences")
}

// AI Model Health Status - Real-time monitoring
model AIModelHealth {
  id          String    @id @default(uuid())
  modelId     String    @unique @map("model_id")
  provider    String
  status      String    @default("unknown") // healthy, degraded, down, unknown
  latencyMs   Int?      @map("latency_ms")
  errorRate   Decimal?  @map("error_rate") @db.Decimal(5, 2) // Percentage 0-100
  lastChecked DateTime  @default(now()) @map("last_checked")
  lastError   String?   @map("last_error")
  lastSuccess DateTime? @map("last_success")
  checksCount Int       @default(0) @map("checks_count")
  failsCount  Int       @default(0) @map("fails_count")
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([provider])
  @@index([lastChecked])
  @@map("ai_model_health")
}

// AI Rate Limit Configuration
model AIRateLimit {
  id                String   @id @default(uuid())
  modelId           String   @map("model_id")
  accountId         String?  @map("account_id") // null for global
  requestsPerMinute Int?     @map("requests_per_minute")
  requestsPerHour   Int?     @map("requests_per_hour")
  requestsPerDay    Int?     @map("requests_per_day")
  tokensPerMinute   Int?     @map("tokens_per_minute")
  tokensPerHour     Int?     @map("tokens_per_hour")
  tokensPerDay      Int?     @map("tokens_per_day")
  enabled           Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([modelId, accountId])
  @@index([modelId])
  @@index([accountId])
  @@map("ai_rate_limits")
}

// AI Cost Tracking
model AICostTracking {
  id           String   @id @default(uuid())
  modelId      String   @map("model_id")
  accountId    String   @map("account_id")
  userId       String?  @map("user_id")
  period       String // daily, weekly, monthly
  periodStart  DateTime @map("period_start")
  periodEnd    DateTime @map("period_end")
  inputTokens  Int      @default(0) @map("input_tokens")
  outputTokens Int      @default(0) @map("output_tokens")
  totalCost    Decimal  @default(0) @map("total_cost") @db.Decimal(10, 4)
  requestCount Int      @default(0) @map("request_count")
  errorCount   Int      @default(0) @map("error_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([modelId, accountId, period, periodStart])
  @@index([accountId, periodStart])
  @@index([modelId, periodStart])
  @@map("ai_cost_tracking")
}

// ============================================
// IAI Injection System
// ============================================

// Injection Container - Groups related patterns
model InjectionContainer {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  category    String   @default("custom") // fbm_flow, messaging, analytics, automation, custom
  icon        String? // Icon identifier for UI
  color       String? // Color theme for UI
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  priority    Int      @default(0) // Higher = more likely to be selected
  config      Json     @default("{}") // Container-level configuration
  metadata    Json     @default("{}") // Additional metadata
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  patterns      InjectionPattern[]
  missions      Mission[]
  injectionLogs InjectionLog[]

  @@index([category])
  @@index([isActive])
  @@index([isDefault])
  @@index([priority])
  @@map("injection_containers")
}

// Injection Pattern - The actual injectable code/logic
model InjectionPattern {
  id          String  @id @default(uuid())
  containerId String  @map("container_id")
  name        String
  description String? @db.Text
  code        String  @db.Text // The injectable code/logic
  codeType    String  @default("javascript") @map("code_type") // javascript, json, workflow
  version     String  @default("1.0.0")
  isDefault   Boolean @default(false) @map("is_default")
  isActive    Boolean @default(true) @map("is_active")
  priority    Int     @default(0) // Higher = more likely if random selection
  weight      Int     @default(100) // Weight for weighted random selection (0-100)

  // Configuration
  timeout       Int    @default(30000) // ms timeout for execution
  retryCount    Int    @default(3) @map("retry_count")
  failureAction String @default("skip") @map("failure_action") // skip, retry, abort
  preConditions Json   @default("[]") @map("pre_conditions") // Conditions to check before injection
  postActions   Json   @default("[]") @map("post_actions") // Actions after successful injection

  // Statistics (denormalized for performance)
  totalExecutions  Int       @default(0) @map("total_executions")
  successCount     Int       @default(0) @map("success_count")
  failureCount     Int       @default(0) @map("failure_count")
  avgExecutionTime Int       @default(0) @map("avg_execution_time") // ms
  lastExecutedAt   DateTime? @map("last_executed_at")
  lastSuccessAt    DateTime? @map("last_success_at")
  lastFailureAt    DateTime? @map("last_failure_at")
  lastError        String?   @map("last_error") @db.Text

  // Metadata
  tags      String[] @default([])
  metadata  Json     @default("{}")
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  container     InjectionContainer @relation(fields: [containerId], references: [id], onDelete: Cascade)
  injectionLogs InjectionLog[]
  missionTasks  MissionTask[]

  @@unique([containerId, name])
  @@index([containerId])
  @@index([isActive])
  @@index([isDefault])
  @@index([priority])
  @@index([weight])
  @@map("injection_patterns")
}

// Injection Log - Tracks every injection execution
model InjectionLog {
  id            String  @id @default(uuid())
  containerId   String  @map("container_id")
  patternId     String  @map("pattern_id")
  iaiInstanceId String? @map("iai_instance_id")
  missionId     String? @map("mission_id")
  taskId        String? @map("task_id")

  status          String @default("pending") // pending, running, success, failure, aborted
  executionTimeMs Int?   @map("execution_time_ms")
  retryAttempt    Int    @default(0) @map("retry_attempt")

  input      Json    @default("{}") // Input data for the injection
  output     Json? // Output/result from injection
  error      String? @db.Text
  stackTrace String? @map("stack_trace") @db.Text

  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  container InjectionContainer @relation(fields: [containerId], references: [id])
  pattern   InjectionPattern   @relation(fields: [patternId], references: [id])

  @@index([containerId])
  @@index([patternId])
  @@index([iaiInstanceId])
  @@index([missionId])
  @@index([status])
  @@index([startedAt])
  @@map("injection_logs")
}

// ============================================
// Mission Control System
// ============================================

// Mission - A planned/scheduled set of tasks
model Mission {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  type        String  @default("manual") // scheduled, manual, triggered, continuous
  status      String  @default("draft") // draft, active, paused, completed, failed, archived
  priority    Int     @default(0) // Mission priority

  // Container assignment
  containerId String? @map("container_id")

  // Scheduling
  scheduleType    String?   @map("schedule_type") // cron, interval, once
  cronExpression  String?   @map("cron_expression")
  intervalMinutes Int?      @map("interval_minutes")
  timezone        String    @default("UTC")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  lastRunAt       DateTime? @map("last_run_at")
  nextRunAt       DateTime? @map("next_run_at")

  // Configuration
  maxConcurrency  Int     @default(1) @map("max_concurrency")
  retryPolicy     String  @default("none") @map("retry_policy") // none, linear, exponential
  maxRetries      Int     @default(3) @map("max_retries")
  alertOnFailure  Boolean @default(true) @map("alert_on_failure")
  alertOnSuccess  Boolean @default(false) @map("alert_on_success")
  abortOnTaskFail Boolean @default(false) @map("abort_on_task_fail")

  // Execution stats
  totalRuns     Int @default(0) @map("total_runs")
  successRuns   Int @default(0) @map("success_runs")
  failedRuns    Int @default(0) @map("failed_runs")
  avgDurationMs Int @default(0) @map("avg_duration_ms")

  // Metadata
  tags      String[] @default([])
  config    Json     @default("{}")
  metadata  Json     @default("{}")
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  container  InjectionContainer? @relation(fields: [containerId], references: [id])
  tasks      MissionTask[]
  executions MissionExecution[]

  @@index([status])
  @@index([type])
  @@index([containerId])
  @@index([nextRunAt])
  @@index([priority])
  @@map("missions")
}

// Mission Task - Individual task within a mission
model MissionTask {
  id          String  @id @default(uuid())
  missionId   String  @map("mission_id")
  patternId   String? @map("pattern_id") // Optional, can be custom task
  name        String
  description String? @db.Text
  taskType    String  @default("pattern") @map("task_type") // pattern, webhook, delay, condition
  order       Int     @default(0) // Execution order

  // Task configuration
  config     Json @default("{}")
  input      Json @default("{}") // Static input for the task
  timeout    Int  @default(30000) // ms
  retryCount Int  @default(0) @map("retry_count")

  // Conditional execution
  condition       String? // JavaScript expression to evaluate
  skipOnCondition Boolean @default(false) @map("skip_on_condition")

  // Dependencies
  dependsOn String[] @default([]) @map("depends_on") // Task IDs this task depends on

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mission  Mission           @relation(fields: [missionId], references: [id], onDelete: Cascade)
  pattern  InjectionPattern? @relation(fields: [patternId], references: [id])
  taskRuns MissionTaskRun[]

  @@index([missionId])
  @@index([patternId])
  @@index([order])
  @@map("mission_tasks")
}

// Mission Execution - Each run of a mission
model MissionExecution {
  id              String  @id @default(uuid())
  missionId       String  @map("mission_id")
  status          String  @default("pending") // pending, running, completed, failed, aborted
  triggeredBy     String? @map("triggered_by") // scheduler, manual, api, webhook
  triggeredUserId String? @map("triggered_user_id")

  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  durationMs  Int?      @map("duration_ms")

  // Results
  tasksTotal     Int @default(0) @map("tasks_total")
  tasksCompleted Int @default(0) @map("tasks_completed")
  tasksFailed    Int @default(0) @map("tasks_failed")
  tasksSkipped   Int @default(0) @map("tasks_skipped")

  output Json?
  error  String? @db.Text
  logs   Json    @default("[]") // Execution logs

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  mission  Mission          @relation(fields: [missionId], references: [id], onDelete: Cascade)
  taskRuns MissionTaskRun[]

  @@index([missionId])
  @@index([status])
  @@index([startedAt])
  @@map("mission_executions")
}

// Mission Task Run - Individual task execution within a mission run
model MissionTaskRun {
  id          String @id @default(uuid())
  executionId String @map("execution_id")
  taskId      String @map("task_id")
  status      String @default("pending") // pending, running, completed, failed, skipped

  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  durationMs   Int?      @map("duration_ms")
  retryAttempt Int       @default(0) @map("retry_attempt")

  input  Json?
  output Json?
  error  String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  execution MissionExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  task      MissionTask      @relation(fields: [taskId], references: [id])

  @@index([executionId])
  @@index([taskId])
  @@index([status])
  @@map("mission_task_runs")
}
