// Production-level Prisma Schema for Dealers Face
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Account Management
// ============================================

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  passwordHash   String?   @map("password_hash")
  firstName      String?   @map("first_name")
  lastName       String?   @map("last_name")
  phone          String?
  isActive       Boolean   @default(true) @map("is_active")
  emailVerified  Boolean   @default(false) @map("email_verified")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  lastLoginAt    DateTime? @map("last_login_at")

  // Two-Factor Authentication
  twoFactorEnabled     Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?  @map("two_factor_secret")
  twoFactorBackupCodes String[] @default([]) @map("two_factor_backup_codes")

  // NOTE: The following fields were removed because they don't exist in production DB
  // Run `npx prisma migrate deploy` on production to add them back
  // profilePicture, fbUsername, fbPassword, fb2faCodes, fbLastSync
  // facebookId, facebookAccessToken, facebookTokenExpiry

  // Relations
  accountUsers        AccountUser[]
  facebookProfiles    FacebookProfile[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  apiKeys             ApiKey[]
  assignedLeads       Lead[]               @relation("AssignedLeads")
  salesRepMappings    SalesRepMapping[]
  leadActivities      LeadActivity[]
  dealerAccount       DealerAccount?

  @@map("users")
}

model Account {
  id                 String    @id @default(uuid())
  name               String
  dealershipName     String?   @map("dealership_name")
  address            String?
  city               String?
  state              String?
  zip                String?
  phone              String?
  website            String?
  logoUrl            String?   @map("logo_url")
  isActive           Boolean   @default(true) @map("is_active")
  // Billing & Subscription
  stripeCustomerId   String?   @unique @map("stripe_customer_id")
  subscriptionPlanId String?   @map("subscription_plan_id")
  subscriptionStatus String    @default("trial") @map("subscription_status") // trial, active, past_due, canceled, paused
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  trialEndsAt        DateTime? @map("trial_ends_at")
  activeUserCount    Int       @default(0) @map("active_user_count")
  extraUserCharge    Decimal   @default(0) @map("extra_user_charge") @db.Decimal(10, 2)

  // FTP Configuration
  ftpHost     String? @map("ftp_host")
  ftpPort     Int?    @default(21) @map("ftp_port")
  ftpUsername String? @map("ftp_username")
  ftpPassword String? @map("ftp_password") // Encrypted
  csvPath     String? @map("csv_path")

  // Sync Settings
  autoSync     Boolean @default(true) @map("auto_sync")
  syncInterval Int     @default(3) @map("sync_interval") // hours

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accountUsers      AccountUser[]
  vehicles          Vehicle[]
  ftpConfigurations FtpConfiguration[]
  syncJobs          SyncJob[]
  facebookProfiles  FacebookProfile[]
  facebookGroups    FacebookGroup[]
  settings          AccountSettings?
  subscriptionPlan  SubscriptionPlan?  @relation(fields: [subscriptionPlanId], references: [id])
  payments          Payment[]
  invoices          Invoice[]
  apiKeys           ApiKey[]
  adfConfiguration  ADFConfiguration?
  leads             Lead[]

  @@map("accounts")
}

// Role enum for AccountUser
enum UserRole {
  SUPER_ADMIN // Company owner - full system access
  ACCOUNT_OWNER // Dealership owner - full account access
  ADMIN // Account admin - manage users, settings, templates
  SALES_REP // Sales representative - personal posting only
  VIEWER // Read-only access
}

model AccountUser {
  id          String   @id @default(uuid())
  accountId   String   @map("account_id")
  userId      String   @map("user_id")
  role        UserRole @default(SALES_REP)
  permissions Json? // Custom permissions override
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@map("account_users")
}

model AccountSettings {
  id                 String   @id @default(uuid())
  accountId          String   @unique @map("account_id")
  autoSyncEnabled    Boolean  @default(true) @map("auto_sync_enabled")
  syncIntervalHours  Int      @default(3) @map("sync_interval_hours")
  postsPerRun        Int      @default(1) @map("posts_per_run")
  autoMarkSold       Boolean  @default(true) @map("auto_mark_sold")
  autoUpdatePrice    Boolean  @default(true) @map("auto_update_price")
  includeStockNumber Boolean  @default(true) @map("include_stock_number")
  useAiDescription   Boolean  @default(false) @map("use_ai_description")
  customDescription  String?  @map("custom_description") @db.Text
  vehicleCategory    String   @default("Car/Truck") @map("vehicle_category")
  emojiSuffix        String   @default("ðŸ¤˜") @map("emoji_suffix")
  mileageUnit        String   @default("Miles") @map("mileage_unit")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("account_settings")
}

// ============================================
// Facebook Integration
// ============================================

model FacebookProfile {
  id               String    @id @default(uuid())
  accountId        String    @map("account_id")
  userId           String    @map("user_id")
  pageId           String    @map("page_id") // Facebook Page ID
  pageName         String    @map("page_name")
  category         String    @default("Automotive") // Page category
  facebookUserId   String    @map("facebook_user_id")
  facebookUserName String?   @map("facebook_user_name")
  accessToken      String    @map("access_token") @db.Text
  refreshToken     String?   @map("refresh_token") @db.Text
  tokenExpiresAt   DateTime  @map("token_expires_at")
  isActive         Boolean   @default(true) @map("is_active")
  lastSyncAt       DateTime? @map("last_sync_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  account Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts   FacebookPost[]

  @@unique([accountId, pageId])
  @@map("facebook_profiles")
}

model FacebookGroup {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  groupId      String    @map("group_id") // Facebook Group ID
  name         String
  url          String?
  memberCount  Int?      @map("member_count")
  isActive     Boolean   @default(true) @map("is_active")
  autoPost     Boolean   @default(false) @map("auto_post")
  lastPostedAt DateTime? @map("last_posted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, groupId])
  @@map("facebook_groups")
}

model FacebookPost {
  id            String    @id @default(uuid())
  vehicleId     String    @map("vehicle_id")
  profileId     String    @map("profile_id")
  postId        String?   @map("post_id") // Facebook post ID
  message       String?   @db.Text
  status        String    @default("pending") // PENDING, ACTIVE, FAILED, DELETED
  errorMessage  String?   @map("error_message") @db.Text
  postUrl       String?   @map("post_url")
  postedAt      DateTime? @map("posted_at")
  deletedAt     DateTime? @map("deleted_at")
  lastUpdatedAt DateTime? @map("last_updated_at")
  retryCount    Int       @default(0) @map("retry_count")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  profile FacebookProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([profileId])
  @@map("facebook_posts")
}

// ============================================
// Vehicle Management
// ============================================

model Vehicle {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Identifiers
  vin         String
  stockNumber String? @map("stock_number")
  dealerId    String? @map("dealer_id")

  // Basic Info
  year      Int
  make      String
  model     String
  trim      String?
  bodyStyle String? @map("body_style")
  bodyType  String? @map("body_type")

  // Pricing
  price          Decimal? @db.Decimal(10, 2) // Primary price field
  listPrice      Decimal? @map("list_price") @db.Decimal(10, 2)
  specialPrice   Decimal? @map("special_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)
  wholesalePrice Decimal? @map("wholesale_price") @db.Decimal(10, 2)

  // Specifications
  mileage           Int?
  exteriorColor     String? @map("exterior_color")
  exteriorColorCode String? @map("exterior_color_code")
  interiorColor     String? @map("interior_color")
  interiorColorCode String? @map("interior_color_code")
  interiorMaterial  String? @map("interior_material")

  // Engine & Drivetrain
  engineDescription  String? @map("engine_description")
  engineDisplacement String? @map("engine_displacement")
  cylinders          String?
  drivetrain         String?
  transmission       String?
  transmissionType   String? @map("transmission_type")
  fuelType           String? @map("fuel_type")
  cityMpg            Int?    @map("city_mpg")
  hwyMpg             Int?    @map("hwy_mpg")

  // Status
  isNew            Boolean @default(false) @map("is_new")
  factoryCertified Boolean @default(false) @map("factory_certified")
  dealerCertified  Boolean @default(false) @map("dealer_certified")
  status           String  @default("active") // active, sold, pending, hidden

  // Descriptions
  title             String?
  description       String? @db.Text
  dealerComments    String? @map("dealer_comments") @db.Text
  optionDescription String? @map("option_description") @db.Text
  optionCodes       String? @map("option_codes") @db.Text

  // Metadata
  instockDate      DateTime? @map("instock_date")
  lastModifiedDate DateTime? @map("last_modified_date")
  videoUrl         String?   @map("video_url")
  imageUrls        String[]  @default([]) @map("image_urls") // Array of image URLs
  source           String    @default("MANUAL") // MANUAL, FTP, API

  // Tracking
  lastSyncedAt DateTime? @map("last_synced_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  photos        VehiclePhoto[]
  facebookPosts FacebookPost[]
  leads         Lead[]

  @@unique([accountId, vin])
  @@index([accountId, status])
  @@index([vin])
  @@index([stockNumber])
  @@map("vehicles")
}

model VehiclePhoto {
  id           String   @id @default(uuid())
  vehicleId    String   @map("vehicle_id")
  url          String
  displayOrder Int      @default(0) @map("display_order")
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_photos")
}

// ============================================
// Data Sync & FTP
// ============================================

model FtpConfiguration {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  name         String
  host         String
  port         Int       @default(21)
  username     String
  password     String // Encrypted in application
  path         String    @default("/")
  protocol     String    @default("ftp") // ftp, sftp, ftps
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastTestedAt DateTime? @map("last_tested_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("ftp_configurations")
}

model SyncJob {
  id                 String    @id @default(uuid())
  accountId          String    @map("account_id")
  triggeredBy        String?   @map("triggered_by") // User ID who triggered manual sync
  status             String    @default("pending") // PENDING, PROCESSING, COMPLETED, FAILED
  type               String    @default("auto") // auto, manual
  recordsImported    Int       @default(0) @map("records_imported")
  recordsUpdated     Int       @default(0) @map("records_updated")
  recordsFailed      Int       @default(0) @map("records_failed")
  vehiclesAdded      Int       @default(0) @map("vehicles_added")
  vehiclesUpdated    Int       @default(0) @map("vehicles_updated")
  vehiclesMarkedSold Int       @default(0) @map("vehicles_marked_sold")
  errorMessage       String?   @map("error_message") @db.Text
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
  @@map("sync_jobs")
}

// ============================================
// Security & Audit
// ============================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String // Key identifier (e.g., "Chrome Extension - Desktop")
  keyHash     String    @unique @map("key_hash") // SHA256 hash of the key
  userId      String    @map("user_id")
  accountId   String    @map("account_id")
  permissions String[]  @default([]) // Array of permissions
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@map("api_keys")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String // info, warning, error, success
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ============================================
// Subscription & Billing Management
// ============================================

model SubscriptionPlan {
  id              String  @id @default(uuid())
  name            String  @unique // "Starter", "Growth", "Pro", "Enterprise Lifetime"
  slug            String  @unique @default("") // URL-friendly identifier
  description     String? @db.Text // Plan description
  stripePriceId   String? @unique @map("stripe_price_id")
  stripeProductId String? @map("stripe_product_id")
  basePrice       Decimal @map("base_price") @db.Decimal(10, 2) // Monthly price
  billingInterval String  @map("billing_interval") // "monthly", "yearly", "lifetime"
  includedUsers   Int     @map("included_users") // 10, 25, unlimited (-1)
  extraUserPrice  Decimal @map("extra_user_price") @db.Decimal(10, 2) // Price per extra user
  maxVehicles     Int     @default(-1) @map("max_vehicles") // -1 = unlimited
  maxPosts        Int     @default(-1) @map("max_posts") // -1 = unlimited posts per month
  features        Json? // JSON array of feature strings
  isActive        Boolean @default(true) @map("is_active")
  isPopular       Boolean @default(false) @map("is_popular") // Highlight as popular plan
  displayOrder    Int     @default(0) @map("display_order")

  // Lifetime plan specifics
  lifetimeDuration Int?     @map("lifetime_duration") // In years (e.g., 4)
  renewalPrice     Decimal? @map("renewal_price") @db.Decimal(10, 2) // Price to renew lifetime
  revertToPlanId   String?  @map("revert_to_plan_id") // Plan ID to revert after lifetime expires

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts      Account[]
  revertPlan    SubscriptionPlan?  @relation("PlanReversion", fields: [revertToPlanId], references: [id])
  revertedPlans SubscriptionPlan[] @relation("PlanReversion")

  @@map("subscription_plans")
}

model Payment {
  id              String    @id @default(uuid())
  accountId       String    @map("account_id")
  stripePaymentId String    @unique @map("stripe_payment_id")
  stripeInvoiceId String?   @map("stripe_invoice_id")
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("usd")
  status          String // succeeded, pending, failed, refunded
  paymentMethod   String?   @map("payment_method") // card, bank_transfer, etc.
  description     String?   @db.Text
  metadata        Json? // Extra data from Stripe
  paidAt          DateTime? @map("paid_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  account Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [stripeInvoiceId], references: [stripeInvoiceId])

  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Invoice {
  id              String  @id @default(uuid())
  accountId       String  @map("account_id")
  stripeInvoiceId String  @unique @map("stripe_invoice_id")
  invoiceNumber   String? @unique @map("invoice_number")
  amountDue       Decimal @map("amount_due") @db.Decimal(10, 2)
  amountPaid      Decimal @map("amount_paid") @db.Decimal(10, 2)
  currency        String  @default("usd")
  status          String // draft, open, paid, void, uncollectible
  hostedUrl       String? @map("hosted_url") @db.Text
  pdfUrl          String? @map("pdf_url") @db.Text

  // Line items breakdown
  baseCharge      Decimal @default(0) @map("base_charge") @db.Decimal(10, 2)
  extraUserCharge Decimal @default(0) @map("extra_user_charge") @db.Decimal(10, 2)
  extraUserCount  Int     @default(0) @map("extra_user_count")

  periodStart DateTime  @map("period_start")
  periodEnd   DateTime  @map("period_end")
  dueDate     DateTime? @map("due_date")
  paidAt      DateTime? @map("paid_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([accountId])
  @@index([status])
  @@map("invoices")
}

model SubscriptionHistory {
  id           String   @id @default(uuid())
  accountId    String   @map("account_id")
  planId       String?  @map("plan_id")
  planName     String   @map("plan_name")
  action       String // created, upgraded, downgraded, canceled, renewed, expired
  previousPlan String?  @map("previous_plan")
  newPlan      String?  @map("new_plan")
  amount       Decimal? @db.Decimal(10, 2)
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@index([createdAt])
  @@map("subscription_history")
}

model EmailLog {
  id           String  @id @default(uuid())
  recipient    String
  subject      String
  status       String // QUEUED, SENDING, SENT, DELIVERED, BOUNCED, FAILED, DEFERRED
  messageId    String? @map("message_id")
  errorMessage String? @map("error_message") @db.Text
  metadata     Json? // Additional data like template name, variables

  // MTA Tracking
  mtaMessageId String? @map("mta_message_id") // Local MTA message ID
  mtaResponse  String? @map("mta_response") @db.Text // MTA response

  // Delivery Tracking
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  bouncedAt   DateTime? @map("bounced_at")

  // Engagement Tracking
  openedAt   DateTime? @map("opened_at")
  openCount  Int       @default(0) @map("open_count")
  clickedAt  DateTime? @map("clicked_at")
  clickCount Int       @default(0) @map("click_count")

  // Bounce/Complaint Info
  bounceType   String?   @map("bounce_type") // HARD, SOFT
  bounceReason String?   @map("bounce_reason") @db.Text
  isComplaint  Boolean   @default(false) @map("is_complaint")
  complainedAt DateTime? @map("complained_at")

  // Retry Management
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  nextRetryAt DateTime? @map("next_retry_at")

  // Reference
  accountId    String? @map("account_id")
  userId       String? @map("user_id") // Sent by
  templateSlug String? @map("template_slug")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@index([accountId])
  @@index([messageId])
  @@map("email_logs")
}

// Email Queue - For reliable email delivery
model EmailQueue {
  id String @id @default(uuid())

  // Email Details
  fromEmail String   @map("from_email")
  fromName  String?  @map("from_name")
  toEmail   String   @map("to_email")
  toName    String?  @map("to_name")
  ccEmails  String[] @default([]) @map("cc_emails")
  bccEmails String[] @default([]) @map("bcc_emails")
  replyTo   String?  @map("reply_to")

  // Content
  subject     String
  htmlContent String  @map("html_content") @db.Text
  textContent String? @map("text_content") @db.Text
  headers     Json? // Custom headers including DKIM signature

  // Tracking
  trackingId  String  @unique @map("tracking_id") // For open/click tracking
  trackOpens  Boolean @default(true) @map("track_opens")
  trackClicks Boolean @default(true) @map("track_clicks")

  // Status
  status   String @default("PENDING") // PENDING, PROCESSING, SENT, FAILED, DEFERRED
  priority Int    @default(5) // 1-10 (1 = highest)

  // Delivery Tracking
  messageId    String? @map("message_id")
  mtaMessageId String? @map("mta_message_id")
  mtaResponse  String? @map("mta_response") @db.Text
  errorMessage String? @map("error_message") @db.Text

  // Retry Logic
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  nextAttemptAt DateTime? @map("next_attempt_at")
  lastAttemptAt DateTime? @map("last_attempt_at")
  lastError     String?   @map("last_error") @db.Text

  // Scheduling
  scheduledAt DateTime? @map("scheduled_at")
  processedAt DateTime? @map("processed_at")

  // Reference
  accountId    String? @map("account_id")
  userId       String? @map("user_id")
  templateSlug String? @map("template_slug")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status, priority, scheduledAt])
  @@index([nextAttemptAt])
  @@index([toEmail])
  @@index([trackingId])
  @@map("email_queue")
}

// Email Tracking Events
model EmailTrackingEvent {
  id         String  @id @default(uuid())
  trackingId String  @map("tracking_id")
  emailLogId String? @map("email_log_id")

  // Event Details
  eventType String // OPEN, CLICK, BOUNCE, COMPLAINT, DELIVERY

  // Click Tracking
  url        String? @db.Text // Alias for clickedUrl 
  clickedUrl String? @map("clicked_url") @db.Text

  // Bounce Info
  bounceType   String? @map("bounce_type")
  bounceReason String? @map("bounce_reason") @db.Text

  // Client Info
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text
  country   String?
  city      String?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([trackingId])
  @@index([eventType])
  @@index([createdAt])
  @@map("email_tracking_events")
}

// Email Domain Configuration - DKIM/SPF/DMARC
model EmailDomain {
  id     String @id @default(uuid())
  domain String @unique

  // DKIM Configuration
  dkimSelector   String  @default("mail") @map("dkim_selector")
  dkimPrivateKey String? @map("dkim_private_key") @db.Text // Encrypted
  dkimPublicKey  String? @map("dkim_public_key") @db.Text
  dkimEnabled    Boolean @default(false) @map("dkim_enabled")

  // DNS Records (for verification guidance)
  spfRecord   String? @map("spf_record") @db.Text
  dmarcRecord String? @map("dmarc_record") @db.Text
  dkimRecord  String? @map("dkim_record") @db.Text

  // Verification Status
  spfVerified    Boolean   @default(false) @map("spf_verified")
  dkimVerified   Boolean   @default(false) @map("dkim_verified")
  dmarcVerified  Boolean   @default(false) @map("dmarc_verified")
  isVerified     Boolean   @default(false) @map("is_verified") // Overall verification
  lastVerifiedAt DateTime? @map("last_verified_at")

  // Domain Reputation
  reputation      Int   @default(100) // Alias for reputationScore
  reputationScore Int   @default(100) @map("reputation_score") // 0-100
  totalSent       Int   @default(0) @map("total_sent")
  totalBounced    Int   @default(0) @map("total_bounced")
  totalComplaints Int   @default(0) @map("total_complaints")
  bounceRate      Float @default(0) @map("bounce_rate")
  complaintRate   Float @default(0) @map("complaint_rate")

  // Rate Limiting
  hourlyLimit      Int       @default(100) @map("hourly_limit")
  dailyLimit       Int       @default(1000) @map("daily_limit")
  currentHourCount Int       @default(0) @map("current_hour_count")
  currentDayCount  Int       @default(0) @map("current_day_count")
  hourResetAt      DateTime? @map("hour_reset_at")
  dayResetAt       DateTime? @map("day_reset_at")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isDefault Boolean @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_domains")
}

// Email Suppression List - Bounces, Unsubscribes, Complaints
model EmailSuppression {
  id    String @id @default(uuid())
  email String @unique

  // Suppression Reason
  reason  String // BOUNCE_HARD, BOUNCE_SOFT, UNSUBSCRIBE, COMPLAINT, MANUAL
  details String? @db.Text

  // Source
  sourceType String? @map("source_type") // EMAIL_LOG_ID, WEBHOOK, MANUAL
  sourceId   String? @map("source_id")

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at") // For soft bounces

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([reason])
  @@map("email_suppressions")
}

// Email Statistics - Aggregated stats
model EmailStats {
  id String @id @default(uuid())

  // Time Period
  period      String // HOUR, DAY, WEEK, MONTH
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // Sending Stats
  totalQueued   Int @default(0) @map("total_queued")
  totalSent     Int @default(0) @map("total_sent")
  totalFailed   Int @default(0) @map("total_failed")
  totalDeferred Int @default(0) @map("total_deferred")

  // Delivery Stats
  totalDelivered Int @default(0) @map("total_delivered")
  totalBounced   Int @default(0) @map("total_bounced")
  hardBounces    Int @default(0) @map("hard_bounces")
  softBounces    Int @default(0) @map("soft_bounces")

  // Engagement Stats
  totalOpened       Int @default(0) @map("total_opened")
  uniqueOpens       Int @default(0) @map("unique_opens")
  totalClicked      Int @default(0) @map("total_clicked")
  uniqueClicks      Int @default(0) @map("unique_clicks")
  totalComplaints   Int @default(0) @map("total_complaints")
  totalUnsubscribes Int @default(0) @map("total_unsubscribes")

  // Rates
  deliveryRate  Float @default(0) @map("delivery_rate")
  bounceRate    Float @default(0) @map("bounce_rate")
  openRate      Float @default(0) @map("open_rate")
  clickRate     Float @default(0) @map("click_rate")
  complaintRate Float @default(0) @map("complaint_rate")

  // Domain
  domain    String?
  accountId String? @map("account_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([period, periodStart, domain, accountId])
  @@index([period, periodStart])
  @@index([domain])
  @@map("email_stats")
}

// ============================================
// System Settings (Super Admin)
// ============================================

model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique // general, email, security, integrations
  value     Json // JSON object with all settings for this category
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String // Human readable name
  slug        String   @unique // welcome, password-reset, sync-complete, new-lead
  subject     String
  htmlContent String   @map("html_content") @db.Text
  textContent String?  @map("text_content") @db.Text
  variables   String[] @default([]) // Available template variables like firstName, siteName
  description String?  @db.Text // Template usage description
  isActive    Boolean  @default(true) @map("is_active")
  isSystem    Boolean  @default(false) @map("is_system") // System templates can't be deleted
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

// ============================================
// ADF (Auto-Lead Data Format) Lead Management
// ============================================

// Lead Status Enum
enum LeadStatus {
  NEW // Just received, unassigned
  ASSIGNED // Assigned to a sales rep
  CONTACTED // Initial contact made
  QUALIFIED // Lead is qualified/interested
  APPOINTMENT // Appointment scheduled
  NEGOTIATING // In price negotiation
  WON // Sale completed
  LOST // Lead lost to competitor/no interest
  ARCHIVED // Old lead archived
}

// Lead Source Enum
enum LeadSource {
  FACEBOOK_MARKETPLACE
  FACEBOOK_PAGE
  WEBSITE
  WALK_IN
  PHONE
  EMAIL
  REFERRAL
  THIRD_PARTY
  ADF_IMPORT
  MANUAL
}

// Lead Priority Enum
enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model ADFConfiguration {
  id        String @id @default(uuid())
  accountId String @unique @map("account_id")

  // DMS Integration Settings
  dmsProvider String? @map("dms_provider") // DealerSocket, CDK, Reynolds, etc.
  dmsEndpoint String? @map("dms_endpoint") // ADF submission URL
  dmsUsername String? @map("dms_username")
  dmsPassword String? @map("dms_password") // Encrypted
  dmsApiKey   String? @map("dms_api_key") // Encrypted

  // Email Settings for ADF
  adfEmailEnabled       Boolean  @default(true) @map("adf_email_enabled")
  adfEmailRecipients    String[] @default([]) @map("adf_email_recipients")
  adfEmailSender        String?  @map("adf_email_sender") // Verified sender email
  adfEmailSubjectPrefix String   @default("[New Lead]") @map("adf_email_subject_prefix")

  // Auto Assignment Rules
  autoAssignEnabled Boolean @default(true) @map("auto_assign_enabled")
  roundRobinEnabled Boolean @default(false) @map("round_robin_enabled")
  defaultAssigneeId String? @map("default_assignee_id") // User ID for default assignment

  // AI Communication Settings
  aiAssistantEnabled Boolean @default(false) @map("ai_assistant_enabled")
  aiResponseTemplate String? @map("ai_response_template") @db.Text
  aiAutoResponse     Boolean @default(false) @map("ai_auto_response")
  aiDelayMinutes     Int     @default(5) @map("ai_delay_minutes") // Delay before AI responds

  // Lead Processing
  duplicateCheckEnabled Boolean @default(true) @map("duplicate_check_enabled")
  duplicateWindowHours  Int     @default(24) @map("duplicate_window_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account          Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  salesRepMappings SalesRepMapping[]

  @@map("adf_configurations")
}

// Sales Rep Mapping - Maps Facebook usernames to DMS sales rep IDs
model SalesRepMapping {
  id              String @id @default(uuid())
  configurationId String @map("configuration_id")
  userId          String @map("user_id") // Internal user ID

  // Facebook Identifiers
  facebookUsername    String? @map("facebook_username")
  facebookUserId      String? @map("facebook_user_id")
  facebookDisplayName String? @map("facebook_display_name")

  // DMS Identifiers
  dmsRepId    String? @map("dms_rep_id") // Sales rep ID in DMS
  dmsRepName  String? @map("dms_rep_name")
  dmsRepEmail String? @map("dms_rep_email")

  // Assignment Settings
  isActive       Boolean   @default(true) @map("is_active")
  maxLeadsPerDay Int?      @map("max_leads_per_day")
  leadCount      Int       @default(0) @map("lead_count")
  lastAssignedAt DateTime? @map("last_assigned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  configuration ADFConfiguration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([configurationId, userId])
  @@map("sales_rep_mappings")
}

// Lead - Main lead entity
model Lead {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Lead Identification
  leadNumber     String  @unique @map("lead_number") // Auto-generated lead ID
  externalLeadId String? @map("external_lead_id") // ID from external source

  // Status & Priority
  status   LeadStatus   @default(NEW)
  priority LeadPriority @default(MEDIUM)
  source   LeadSource   @default(MANUAL)

  // Assignment
  assignedToId String?   @map("assigned_to_id") // User ID of assigned sales rep
  assignedAt   DateTime? @map("assigned_at")

  // Customer Information
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  fullName  String? @map("full_name")
  email     String?
  phone     String?
  altPhone  String? @map("alt_phone")
  address   String?
  city      String?
  state     String?
  zip       String?
  country   String? @default("US")

  // Facebook Information
  facebookUserId       String? @map("facebook_user_id")
  facebookUsername     String? @map("facebook_username")
  facebookDisplayName  String? @map("facebook_display_name")
  facebookProfileUrl   String? @map("facebook_profile_url")
  facebookMessengerUrl String? @map("facebook_messenger_url")

  // Vehicle Interest
  vehicleId             String? @map("vehicle_id") // Link to interested vehicle
  interestedVehicle     String? @map("interested_vehicle") // Text description
  interestedYear        Int?    @map("interested_year")
  interestedMake        String? @map("interested_make")
  interestedModel       String? @map("interested_model")
  interestedVin         String? @map("interested_vin")
  interestedStockNumber String? @map("interested_stock_number")

  // Trade-In Information
  hasTradeIn   Boolean  @default(false) @map("has_trade_in")
  tradeYear    Int?     @map("trade_year")
  tradeMake    String?  @map("trade_make")
  tradeModel   String?  @map("trade_model")
  tradeVin     String?  @map("trade_vin")
  tradeMileage Int?     @map("trade_mileage")
  tradePayoff  Decimal? @map("trade_payoff") @db.Decimal(10, 2)

  // Financial
  budgetMin    Decimal? @map("budget_min") @db.Decimal(10, 2)
  budgetMax    Decimal? @map("budget_max") @db.Decimal(10, 2)
  creditRating String?  @map("credit_rating")
  preApproved  Boolean  @default(false) @map("pre_approved")

  // Comments & Notes
  customerComments String? @map("customer_comments") @db.Text
  internalNotes    String? @map("internal_notes") @db.Text

  // ADF Tracking
  adfSent           Boolean   @default(false) @map("adf_sent")
  adfSentAt         DateTime? @map("adf_sent_at")
  adfMessageId      String?   @map("adf_message_id")
  adfDeliveryStatus String?   @map("adf_delivery_status") // PENDING, SENT, DELIVERED, FAILED
  adfErrorMessage   String?   @map("adf_error_message") @db.Text

  // Tracking
  lastContactedAt DateTime? @map("last_contacted_at")
  nextFollowUpAt  DateTime? @map("next_follow_up_at")
  appointmentAt   DateTime? @map("appointment_at")
  closedAt        DateTime? @map("closed_at")
  closedReason    String?   @map("closed_reason")

  // Metadata
  rawAdfXml String? @map("raw_adf_xml") @db.Text // Original ADF XML
  metadata  Json? // Additional data

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account        Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  assignedTo     User?               @relation("AssignedLeads", fields: [assignedToId], references: [id], onDelete: SetNull)
  vehicle        Vehicle?            @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  communications LeadCommunication[]
  activities     LeadActivity[]
  adfSubmissions ADFSubmission[]
  messages       Message[]

  @@index([accountId, status])
  @@index([assignedToId])
  @@index([email])
  @@index([phone])
  @@index([createdAt])
  @@map("leads")
}

// Lead Communication - Track all communications
model LeadCommunication {
  id     String @id @default(uuid())
  leadId String @map("lead_id")

  // Communication Type
  type      String // EMAIL, SMS, PHONE, FACEBOOK_MESSAGE, AI_RESPONSE
  direction String // INBOUND, OUTBOUND

  // Content
  subject     String?
  content     String  @db.Text
  contentHtml String? @map("content_html") @db.Text

  // Metadata
  senderId       String? @map("sender_id") // User ID or system
  senderName     String? @map("sender_name")
  recipientEmail String? @map("recipient_email")
  recipientPhone String? @map("recipient_phone")

  // Delivery Status
  status       String    @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  readAt       DateTime? @map("read_at")
  errorMessage String?   @map("error_message") @db.Text

  // AI Generated
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiModel       String? @map("ai_model")
  aiPrompt      String? @map("ai_prompt") @db.Text

  // External References
  externalMessageId String? @map("external_message_id")
  facebookMessageId String? @map("facebook_message_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([type])
  @@index([createdAt])
  @@map("lead_communications")
}

// Lead Activity - Track all lead activities
model LeadActivity {
  id     String  @id @default(uuid())
  leadId String  @map("lead_id")
  userId String? @map("user_id")

  // Activity Type
  type        String // STATUS_CHANGE, ASSIGNED, NOTE_ADDED, COMMUNICATION, ADF_SENT, etc.
  title       String
  description String? @db.Text

  // Change Tracking
  previousValue String? @map("previous_value")
  newValue      String? @map("new_value")

  // Metadata
  metadata Json?
  isSystem Boolean @default(false) @map("is_system")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([type])
  @@index([createdAt])
  @@map("lead_activities")
}

// ADF Submission - Track ADF sends to DMS
model ADFSubmission {
  id        String @id @default(uuid())
  leadId    String @map("lead_id")
  accountId String @map("account_id")

  // Submission Type
  method   String // EMAIL, API, HTTP_POST
  endpoint String? // DMS endpoint URL

  // ADF Content
  adfXml     String @map("adf_xml") @db.Text
  adfVersion String @default("1.0") @map("adf_version")

  // Delivery Status
  status        String  @default("PENDING") // PENDING, SENT, DELIVERED, ACKNOWLEDGED, FAILED
  statusMessage String? @map("status_message") @db.Text

  // Response
  responseCode Int?    @map("response_code")
  responseBody String? @map("response_body") @db.Text
  dmsLeadId    String? @map("dms_lead_id") // Lead ID returned by DMS

  // Email Specific
  emailTo             String[] @default([]) @map("email_to")
  emailMessageId      String?  @map("email_message_id")
  emailDeliveryStatus String?  @map("email_delivery_status")

  // Retry
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  nextRetryAt DateTime? @map("next_retry_at")

  // Timestamps
  sentAt         DateTime? @map("sent_at")
  deliveredAt    DateTime? @map("delivered_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  failedAt       DateTime? @map("failed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("adf_submissions")
}

// ============================================
// Chrome Extension Integration
// ============================================

// Task queue for Chrome Extension automation
model ExtensionTask {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Task Type
  type     String // post_vehicle, scrape_inbox, scrape_conversation, respond_lead
  status   String @default("pending") // pending, processing, completed, failed, cancelled
  priority Int    @default(5) // 1-10, higher = more urgent

  // Task Data
  data   Json? // Command data, vehicle info, etc
  result Json? // Task execution result

  // Related Entities
  vehicleId String? @map("vehicle_id")
  leadId    String? @map("lead_id")

  // Scheduling
  scheduledFor DateTime? @map("scheduled_for")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")

  // Retry
  retryCount Int @default(0) @map("retry_count")
  maxRetries Int @default(3) @map("max_retries")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([scheduledFor])
  @@map("extension_tasks")
}

// AI-generated responses for approval
model AIResponse {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  leadId    String @map("lead_id")

  // Response Content
  responseText String @map("response_text") @db.Text
  responseType String @map("response_type") // initial, follow_up, price_negotiation, availability

  // Analysis
  conversationAnalysis Json? @map("conversation_analysis")
  confidence           Float @default(0)

  // Approval Status
  status     String    @default("pending") // pending, approved, rejected, sent
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")
  sentAt     DateTime? @map("sent_at")

  // Edit tracking
  wasEdited  Boolean @default(false) @map("was_edited")
  editedText String? @map("edited_text") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([leadId])
  @@index([status])
  @@map("ai_responses")
}

// Message history for conversation tracking
model Message {
  id                String  @id @default(uuid())
  leadId            String  @map("lead_id")
  facebookMessageId String? @map("facebook_message_id")

  // Content
  text       String  @db.Text
  sender     String // buyer name or "dealer"
  isOutgoing Boolean @default(false) @map("is_outgoing")

  // AI Analysis
  sentiment String? // positive, negative, neutral
  intent    String? // question, interest, negotiation, etc

  // Timestamps
  sentAt    DateTime @map("sent_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([leadId, facebookMessageId])
  @@index([leadId])
  @@index([sentAt])
  @@map("messages")
}

// Facebook session data for the extension
model FacebookSession {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Session cookies (encrypted)
  cookies   String @db.Text
  userAgent String @map("user_agent")

  // Session Status
  isValid       Boolean  @default(true) @map("is_valid")
  lastValidated DateTime @map("last_validated")
  lastActivity  DateTime @map("last_activity")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("facebook_sessions")
}

// DealerAccount for extension integration
model DealerAccount {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Business Info
  businessName    String? @map("business_name")
  businessAddress String? @map("business_address")
  businessPhone   String? @map("business_phone")

  // Facebook Connection
  facebookConnected Boolean @default(false) @map("facebook_connected")
  facebookUserId    String? @map("facebook_user_id")

  // Settings
  autoRespond   Boolean @default(false) @map("auto_respond")
  responseDelay Int     @default(30) @map("response_delay") // seconds

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dealer_accounts")
}

// ============================================
// AI CENTER - COMPREHENSIVE AI MANAGEMENT
// ============================================

// AI Provider Configuration
model AIProvider {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Provider Info
  name        String // anthropic, openai, google, meta, custom
  displayName String @map("display_name")
  apiKey      String @map("api_key") @db.Text // Encrypted
  apiEndpoint String? @map("api_endpoint") // For custom providers
  
  // Model Configuration
  defaultModel   String  @map("default_model")
  availableModels Json   @map("available_models") // Array of model configs
  
  // Capabilities
  capabilities Json // { chat: true, vision: true, function_calling: true, etc }
  
  // Rate Limits
  maxTokensPerMinute Int @default(100000) @map("max_tokens_per_minute")
  maxRequestsPerMinute Int @default(60) @map("max_requests_per_minute")
  currentUsage Json? @map("current_usage") // { tokens: 0, requests: 0, resetAt: date }
  
  // Status
  isActive   Boolean @default(true) @map("is_active")
  isDefault  Boolean @default(false) @map("is_default")
  lastTested DateTime? @map("last_tested")
  healthStatus String @default("unknown") @map("health_status") // healthy, degraded, down, unknown
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  memories AIMemory[]
  trainingSessions AITrainingSession[]
  conversations AIConversation[]
  
  @@unique([accountId, name])
  @@index([accountId])
  @@index([isActive])
  @@map("ai_providers")
}

// AI Shared Memory - Persistent knowledge storage for each AI
model AIMemory {
  id         String @id @default(uuid())
  providerId String @map("provider_id")
  accountId  String @map("account_id")

  // Memory Type
  memoryType String @map("memory_type") // dealer_profile, inventory, customer_patterns, conversation_context, learned_responses, threat_patterns
  
  // Memory Content
  key         String
  value       Json
  embedding   Float[] // Vector embedding for semantic search
  confidence  Float @default(1.0)
  source      String? // Where this memory came from
  
  // Context
  context     Json? // Related context/metadata
  tags        String[] @default([])
  
  // Importance & Decay
  importance  Float @default(0.5) // 0-1, affects retrieval priority
  accessCount Int @default(0) @map("access_count")
  lastAccessed DateTime? @map("last_accessed")
  expiresAt   DateTime? @map("expires_at")
  
  // Versioning
  version     Int @default(1)
  previousVersionId String? @map("previous_version_id")
  
  // Status
  isActive    Boolean @default(true) @map("is_active")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  provider AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, memoryType, key])
  @@index([providerId])
  @@index([accountId])
  @@index([memoryType])
  @@index([tags])
  @@map("ai_memories")
}

// AI Training Session - Training history and progress
model AITrainingSession {
  id         String @id @default(uuid())
  providerId String @map("provider_id")
  accountId  String @map("account_id")

  // Training Info
  name        String
  description String? @db.Text
  trainingType String @map("training_type") // fbm_specialist, customer_service, inventory_expert, threat_detection, navigation
  
  // Training Data
  trainingData Json @map("training_data") // Training examples, prompts, etc
  datasetSize  Int @map("dataset_size")
  
  // Training Configuration
  config Json // { epochs: 3, learning_rate: 0.001, batch_size: 32, etc }
  
  // Progress
  status      String @default("pending") // pending, in_progress, completed, failed, paused
  progress    Float @default(0) // 0-100
  currentStep Int @default(0) @map("current_step")
  totalSteps  Int @map("total_steps")
  
  // Results
  metrics     Json? // { accuracy: 0.95, loss: 0.05, f1_score: 0.92, etc }
  evaluation  Json? // Test results
  artifacts   Json? // Model weights, checkpoints, etc
  
  // Error Handling
  errorLog    Json? @map("error_log")
  lastError   String? @map("last_error") @db.Text
  
  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  provider AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  trainingData2 AITrainingData[]

  @@index([providerId])
  @@index([accountId])
  @@index([trainingType])
  @@index([status])
  @@map("ai_training_sessions")
}

// AI Training Data - Individual training examples
model AITrainingData {
  id        String @id @default(uuid())
  sessionId String @map("session_id")
  accountId String @map("account_id")

  // Data Type
  dataType String @map("data_type") // conversation, scenario, knowledge, threat_example
  category String // fbm_inquiry, price_negotiation, availability, complaint, threat, etc
  
  // Training Example
  input      String @db.Text // The input/prompt
  expectedOutput String @map("expected_output") @db.Text // Expected response
  context    Json? // Additional context
  
  // Quality
  quality    Float @default(1.0) // 0-1, quality score
  isVerified Boolean @default(false) @map("is_verified")
  verifiedBy String? @map("verified_by")
  
  // Usage Stats
  usedInTraining Int @default(0) @map("used_in_training")
  effectiveness Float? // How well this example performed
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  session AITrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([accountId])
  @@index([category])
  @@index([dataType])
  @@map("ai_training_data")
}

// AI Conversation - Full conversation tracking with analysis
model AIConversation {
  id         String @id @default(uuid())
  providerId String @map("provider_id")
  accountId  String @map("account_id")
  leadId     String? @map("lead_id")

  // Conversation Info
  conversationType String @map("conversation_type") // fbm_inquiry, support, negotiation, etc
  channel          String // facebook_marketplace, messenger, web_chat
  
  // Participants
  customerId   String? @map("customer_id")
  customerName String? @map("customer_name")
  agentMode    String @map("agent_mode") // autonomous, supervised, manual
  
  // Context
  vehicleId    String? @map("vehicle_id")
  vehicleInfo  Json? @map("vehicle_info")
  dealerContext Json? @map("dealer_context")
  
  // Conversation State
  status       String @default("active") // active, paused, completed, escalated, flagged
  sentiment    String @default("neutral") // positive, neutral, negative, hostile
  intentStack  Json @default("[]") @map("intent_stack") // Current conversation intents
  
  // Metrics
  messageCount Int @default(0) @map("message_count")
  avgResponseTime Float? @map("avg_response_time") // seconds
  satisfactionScore Float? @map("satisfaction_score")
  
  // Threat Assessment
  threatLevel  String @default("none") @map("threat_level") // none, low, medium, high, critical
  threatFlags  Json @default("[]") @map("threat_flags")
  
  // Escalation
  isEscalated  Boolean @default(false) @map("is_escalated")
  escalatedAt  DateTime? @map("escalated_at")
  escalatedTo  String? @map("escalated_to")
  escalationReason String? @map("escalation_reason") @db.Text
  
  // Resolution
  resolution   String? // sold, not_interested, follow_up, no_response, threat_ended
  resolutionNotes String? @map("resolution_notes") @db.Text
  
  // Timestamps
  startedAt   DateTime @default(now()) @map("started_at")
  lastMessageAt DateTime? @map("last_message_at")
  endedAt     DateTime? @map("ended_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  provider AIProvider @relation(fields: [providerId], references: [id])
  messages AIConversationMessage[]
  threats  AIThreat[]

  @@index([providerId])
  @@index([accountId])
  @@index([leadId])
  @@index([status])
  @@index([threatLevel])
  @@map("ai_conversations")
}

// AI Conversation Messages - Individual messages with full analysis
model AIConversationMessage {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")

  // Message Content
  role       String // user, assistant, system
  content    String @db.Text
  contentType String @default("text") @map("content_type") // text, image, link, attachment
  
  // Analysis
  intent       String? // question, statement, request, complaint, threat, etc
  sentiment    Float? // -1 to 1
  confidence   Float? // AI confidence in response
  topics       String[] @default([])
  entities     Json? // Extracted entities { names, phones, vehicles, etc }
  
  // AI Processing
  tokensUsed   Int? @map("tokens_used")
  modelUsed    String? @map("model_used")
  processingTime Float? @map("processing_time") // ms
  
  // Memory Operations
  memoriesUsed Json? @map("memories_used") // Which memories were accessed
  memoriesCreated Json? @map("memories_created") // New memories created
  
  // Actions Taken
  actions      Json? // { fetched_carfax: true, checked_inventory: true, etc }
  externalCalls Json? @map("external_calls") // API calls made
  
  // Threat Detection
  threatIndicators Json? @map("threat_indicators")
  wasFlagged   Boolean @default(false) @map("was_flagged")
  
  // Human Review
  needsReview  Boolean @default(false) @map("needs_review")
  reviewedBy   String? @map("reviewed_by")
  reviewNotes  String? @map("review_notes") @db.Text
  wasEdited    Boolean @default(false) @map("was_edited")
  originalContent String? @map("original_content") @db.Text
  
  // Timestamps
  sentAt    DateTime @default(now()) @map("sent_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([sentAt])
  @@map("ai_conversation_messages")
}

// AI Threat Detection - Comprehensive threat tracking
model AIThreat {
  id             String @id @default(uuid())
  conversationId String? @map("conversation_id")
  accountId      String @map("account_id")

  // Threat Info
  threatType    String @map("threat_type") // harassment, scam, fraud, violence, discrimination, spam, phishing, profanity, manipulation
  severity      String // low, medium, high, critical
  
  // Detection
  detectedAt    DateTime @map("detected_at")
  detectionMethod String @map("detection_method") // pattern_match, ml_classifier, keyword, sentiment, behavioral
  confidence    Float @default(0.5)
  
  // Evidence
  triggerContent String @map("trigger_content") @db.Text
  context       Json? // Surrounding context
  indicators    Json // List of threat indicators
  
  // Classification
  category      String // legal_threat, personal_attack, competitive_sabotage, etc
  subcategory   String?
  tags          String[] @default([])
  
  // Response Taken
  responseTaken String @map("response_taken") // warning_issued, conversation_ended, user_blocked, escalated, ignored
  responseContent String? @map("response_content") @db.Text
  responseAt    DateTime? @map("response_at")
  
  // Impact Assessment
  businessImpact String? @map("business_impact") // none, low, medium, high
  legalRisk     String? @map("legal_risk") // none, low, medium, high
  
  // Resolution
  status        String @default("active") // active, resolved, escalated, false_positive
  resolvedBy    String? @map("resolved_by")
  resolvedAt    DateTime? @map("resolved_at")
  resolutionNotes String? @map("resolution_notes") @db.Text
  
  // Learning
  addedToTraining Boolean @default(false) @map("added_to_training")
  patternId     String? @map("pattern_id") // Link to threat pattern
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  conversation AIConversation? @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
  @@index([accountId])
  @@index([threatType])
  @@index([severity])
  @@index([status])
  @@map("ai_threats")
}

// AI Threat Pattern - Learned threat detection patterns
model AIThreatPattern {
  id        String @id @default(uuid())
  accountId String? @map("account_id") // null = global pattern

  // Pattern Info
  name        String
  description String? @db.Text
  threatType  String @map("threat_type")
  severity    String
  
  // Detection Rules
  patternType String @map("pattern_type") // regex, keyword, semantic, behavioral, ml_classifier
  pattern     Json // The actual pattern definition
  examples    Json // Example matches
  
  // Effectiveness
  matchCount  Int @default(0) @map("match_count")
  falsePositives Int @default(0) @map("false_positives")
  accuracy    Float? // Calculated accuracy
  
  // Response Template
  defaultResponse String? @map("default_response") @db.Text
  escalationRequired Boolean @default(false) @map("escalation_required")
  
  // Status
  isActive    Boolean @default(true) @map("is_active")
  isGlobal    Boolean @default(false) @map("is_global")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([threatType])
  @@index([isActive])
  @@map("ai_threat_patterns")
}

// AI Learning Pattern - General learning from interactions
model AILearningPattern {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Pattern Info
  patternType String @map("pattern_type") // response_success, customer_preference, negotiation_tactic, objection_handling
  category    String
  
  // Pattern Definition
  trigger     Json // What triggers this pattern
  response    Json // Successful response pattern
  context     Json? // When to apply
  
  // Effectiveness
  successRate Float @map("success_rate") // 0-1
  sampleSize  Int @map("sample_size")
  confidence  Float @default(0.5)
  
  // Usage
  usageCount  Int @default(0) @map("usage_count")
  lastUsed    DateTime? @map("last_used")
  
  // Status
  isActive    Boolean @default(true) @map("is_active")
  isVerified  Boolean @default(false) @map("is_verified")
  verifiedBy  String? @map("verified_by")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([patternType])
  @@index([category])
  @@map("ai_learning_patterns")
}

// AI Task - Todo/Task management for AI operations
model AITask {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  providerId String? @map("provider_id")

  // Task Info
  title       String
  description String? @db.Text
  taskType    String @map("task_type") // auto_respond, follow_up, inventory_update, carfax_fetch, listing_refresh, training, analysis
  
  // Assignment
  assignedTo  String? @map("assigned_to") // AI provider or user
  assignedBy  String? @map("assigned_by")
  
  // Priority & Scheduling
  priority    Int @default(5) // 1-10
  dueAt       DateTime? @map("due_at")
  scheduledFor DateTime? @map("scheduled_for")
  recurringConfig Json? @map("recurring_config") // { interval: "daily", time: "09:00", etc }
  
  // Dependencies
  dependsOn   String[] @default([]) @map("depends_on") // Task IDs this depends on
  blockedBy   String[] @default([]) @map("blocked_by")
  
  // Execution
  status      String @default("pending") // pending, in_progress, completed, failed, cancelled, blocked
  progress    Float @default(0)
  
  // Task Data
  inputData   Json? @map("input_data")
  outputData  Json? @map("output_data")
  
  // Results
  result      Json?
  errorLog    Json? @map("error_log")
  
  // Autonomy
  autonomyLevel String @map("autonomy_level") // full, supervised, manual_approval
  requiresApproval Boolean @default(false) @map("requires_approval")
  approvedBy  String? @map("approved_by")
  approvedAt  DateTime? @map("approved_at")
  
  // Limits
  maxRetries  Int @default(3) @map("max_retries")
  retryCount  Int @default(0) @map("retry_count")
  timeout     Int? // seconds
  
  // Timestamps
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([accountId])
  @@index([providerId])
  @@index([taskType])
  @@index([status])
  @@index([priority])
  @@index([dueAt])
  @@map("ai_tasks")
}

// AI Capability - Defines what the AI can do
model AICapability {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Capability Info
  name        String
  description String? @db.Text
  category    String // navigation, communication, data_access, external_api, file_operations
  
  // Permissions
  isEnabled   Boolean @default(true) @map("is_enabled")
  requiresApproval Boolean @default(false) @map("requires_approval")
  
  // Limits
  rateLimit   Int? @map("rate_limit") // per hour
  dailyLimit  Int? @map("daily_limit")
  monthlyLimit Int? @map("monthly_limit")
  currentUsage Json? @map("current_usage")
  
  // Allowed Operations
  allowedOperations Json @map("allowed_operations") // Specific operations allowed
  blockedOperations Json? @map("blocked_operations") // Explicitly blocked
  
  // Scope
  allowedUrls String[] @default([]) @map("allowed_urls") // For navigation
  blockedUrls String[] @default([]) @map("blocked_urls")
  allowedApis String[] @default([]) @map("allowed_apis") // For external calls
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([accountId, name])
  @@index([accountId])
  @@index([category])
  @@map("ai_capabilities")
}

// AI Audit Log - Complete audit trail of AI actions
model AIAuditLog {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  providerId String? @map("provider_id")

  // Action Info
  action      String // memory_read, memory_write, api_call, navigation, file_upload, response_sent, etc
  category    String // memory, communication, navigation, file, external_api
  
  // Details
  target      String? // What was acted upon
  targetType  String? @map("target_type") // memory, conversation, vehicle, lead, file
  targetId    String? @map("target_id")
  
  // Request/Response
  request     Json?
  response    Json?
  
  // Context
  conversationId String? @map("conversation_id")
  taskId      String? @map("task_id")
  triggeredBy String? @map("triggered_by") // What triggered this action
  
  // Results
  status      String // success, failed, blocked, rate_limited
  errorMessage String? @map("error_message") @db.Text
  
  // Performance
  duration    Float? // ms
  tokensUsed  Int? @map("tokens_used")
  
  // Security
  ipAddress   String? @map("ip_address")
  userAgent   String? @map("user_agent")
  wasBlocked  Boolean @default(false) @map("was_blocked")
  blockReason String? @map("block_reason")
  
  // Timestamps
  performedAt DateTime @default(now()) @map("performed_at")

  @@index([accountId])
  @@index([providerId])
  @@index([action])
  @@index([performedAt])
  @@index([status])
  @@map("ai_audit_logs")
}

// AI External Service Integration - Carfax, AutoCheck, etc
model AIExternalService {
  id        String @id @default(uuid())
  accountId String @map("account_id")

  // Service Info
  name        String // carfax, autocheck, kbb, nada, edmunds
  displayName String @map("display_name")
  serviceType String @map("service_type") // vehicle_history, valuation, market_data
  
  // Credentials (encrypted)
  apiKey      String? @map("api_key") @db.Text
  apiSecret   String? @map("api_secret") @db.Text
  credentials Json? // Other credentials
  
  // Configuration
  baseUrl     String @map("base_url")
  config      Json? // Service-specific config
  
  // Rate Limits
  rateLimit   Int? @map("rate_limit")
  dailyLimit  Int? @map("daily_limit")
  currentUsage Json? @map("current_usage")
  
  // Status
  isActive    Boolean @default(true) @map("is_active")
  lastTested  DateTime? @map("last_tested")
  healthStatus String @default("unknown") @map("health_status")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([accountId, name])
  @@index([accountId])
  @@map("ai_external_services")
}
